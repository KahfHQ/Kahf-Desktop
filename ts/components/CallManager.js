var __create = Object.create;
var __defProp = Object.defineProperty;
var __getOwnPropDesc = Object.getOwnPropertyDescriptor;
var __getOwnPropNames = Object.getOwnPropertyNames;
var __getProtoOf = Object.getPrototypeOf;
var __hasOwnProp = Object.prototype.hasOwnProperty;
var __name = (target, value) => __defProp(target, "name", { value, configurable: true });
var __export = (target, all) => {
  for (var name in all)
    __defProp(target, name, { get: all[name], enumerable: true });
};
var __copyProps = (to, from, except, desc) => {
  if (from && typeof from === "object" || typeof from === "function") {
    for (let key of __getOwnPropNames(from))
      if (!__hasOwnProp.call(to, key) && key !== except)
        __defProp(to, key, { get: () => from[key], enumerable: !(desc = __getOwnPropDesc(from, key)) || desc.enumerable });
  }
  return to;
};
var __toESM = (mod, isNodeMode, target) => (target = mod != null ? __create(__getProtoOf(mod)) : {}, __copyProps(isNodeMode || !mod || !mod.__esModule ? __defProp(target, "default", { value: mod, enumerable: true }) : target, mod));
var __toCommonJS = (mod) => __copyProps(__defProp({}, "__esModule", { value: true }), mod);
var CallManager_exports = {};
__export(CallManager_exports, {
  CallManager: () => CallManager
});
module.exports = __toCommonJS(CallManager_exports);
var import_react = __toESM(require("react"));
var import_lodash = require("lodash");
var import_CallNeedPermissionScreen = require("./CallNeedPermissionScreen");
var import_CallScreen = require("./CallScreen");
var import_CallingLobby = require("./CallingLobby");
var import_CallingParticipantsList = require("./CallingParticipantsList");
var import_CallingSelectPresentingSourcesModal = require("./CallingSelectPresentingSourcesModal");
var import_CallingPip = require("./CallingPip");
var import_IncomingCallBar = require("./IncomingCallBar");
var import_SafetyNumberChangeDialog = require("./SafetyNumberChangeDialog");
var import_Calling = require("../types/Calling");
var import_missingCaseError = require("../util/missingCaseError");
const GROUP_CALL_RING_DURATION = 60 * 1e3;
const ActiveCallManager = /* @__PURE__ */ __name(({
  activeCall,
  availableCameras,
  cancelCall,
  closeNeedPermissionScreen,
  hangUpActiveCall,
  i18n,
  isGroupCallOutboundRingEnabled,
  keyChangeOk,
  getGroupCallVideoFrameSource,
  getPreferredBadge,
  getPresentingSources,
  me,
  openSystemPreferencesAction,
  renderDeviceSelection,
  renderSafetyNumberViewer,
  setGroupCallVideoRequest,
  setLocalAudio,
  setLocalPreview,
  setLocalVideo,
  setPresenting,
  setRendererCanvas,
  setOutgoingRing,
  startCall,
  switchToPresentationView,
  switchFromPresentationView,
  theme,
  toggleParticipants,
  togglePip,
  toggleScreenRecordingPermissionsDialog,
  toggleSettings,
  toggleSpeakerView
}) => {
  const {
    conversation,
    hasLocalAudio,
    hasLocalVideo,
    joinedAt,
    peekedParticipants,
    pip,
    presentingSourcesAvailable,
    settingsDialogOpen,
    showParticipantsList,
    outgoingRing
  } = activeCall;
  const cancelActiveCall = (0, import_react.useCallback)(() => {
    cancelCall({ conversationId: conversation.id });
  }, [cancelCall, conversation.id]);
  const joinActiveCall = (0, import_react.useCallback)(() => {
    startCall({
      callMode: activeCall.callMode,
      conversationId: conversation.id,
      hasLocalAudio,
      hasLocalVideo
    });
  }, [
    startCall,
    activeCall.callMode,
    conversation.id,
    hasLocalAudio,
    hasLocalVideo
  ]);
  const getGroupCallVideoFrameSourceForActiveCall = (0, import_react.useCallback)((demuxId) => {
    return getGroupCallVideoFrameSource(conversation.id, demuxId);
  }, [getGroupCallVideoFrameSource, conversation.id]);
  const setGroupCallVideoRequestForConversation = (0, import_react.useCallback)((resolutions) => {
    setGroupCallVideoRequest({
      conversationId: conversation.id,
      resolutions
    });
  }, [setGroupCallVideoRequest, conversation.id]);
  let isCallFull;
  let showCallLobby;
  let groupMembers;
  switch (activeCall.callMode) {
    case import_Calling.CallMode.Direct: {
      const { callState, callEndedReason } = activeCall;
      const ended = callState === import_Calling.CallState.Ended;
      if (ended && callEndedReason === import_Calling.CallEndedReason.RemoteHangupNeedPermission) {
        return /* @__PURE__ */ import_react.default.createElement(import_CallNeedPermissionScreen.CallNeedPermissionScreen, {
          close: closeNeedPermissionScreen,
          conversation,
          i18n
        });
      }
      showCallLobby = !callState;
      isCallFull = false;
      groupMembers = void 0;
      break;
    }
    case import_Calling.CallMode.Group: {
      showCallLobby = activeCall.joinState !== import_Calling.GroupCallJoinState.Joined;
      isCallFull = activeCall.deviceCount >= activeCall.maxDevices;
      ({ groupMembers } = activeCall);
      break;
    }
    default:
      throw (0, import_missingCaseError.missingCaseError)(activeCall);
  }
  if (showCallLobby) {
    return /* @__PURE__ */ import_react.default.createElement(import_react.default.Fragment, null, /* @__PURE__ */ import_react.default.createElement(import_CallingLobby.CallingLobby, {
      availableCameras,
      conversation,
      groupMembers,
      hasLocalAudio,
      hasLocalVideo,
      i18n,
      isGroupCall: activeCall.callMode === import_Calling.CallMode.Group,
      isGroupCallOutboundRingEnabled,
      isCallFull,
      me,
      onCallCanceled: cancelActiveCall,
      onJoinCall: joinActiveCall,
      outgoingRing,
      peekedParticipants,
      setLocalPreview,
      setLocalAudio,
      setLocalVideo,
      setOutgoingRing,
      showParticipantsList,
      toggleParticipants,
      toggleSettings
    }), settingsDialogOpen && renderDeviceSelection(), showParticipantsList && activeCall.callMode === import_Calling.CallMode.Group ? /* @__PURE__ */ import_react.default.createElement(import_CallingParticipantsList.CallingParticipantsList, {
      i18n,
      onClose: toggleParticipants,
      ourUuid: me.uuid,
      participants: peekedParticipants
    }) : null);
  }
  if (pip) {
    return /* @__PURE__ */ import_react.default.createElement(import_CallingPip.CallingPip, {
      activeCall,
      getGroupCallVideoFrameSource: getGroupCallVideoFrameSourceForActiveCall,
      hangUpActiveCall,
      hasLocalVideo,
      i18n,
      setGroupCallVideoRequest: setGroupCallVideoRequestForConversation,
      setLocalPreview,
      setRendererCanvas,
      switchToPresentationView,
      switchFromPresentationView,
      togglePip
    });
  }
  const groupCallParticipantsForParticipantsList = activeCall.callMode === import_Calling.CallMode.Group ? [
    ...activeCall.remoteParticipants.map((participant) => ({
      ...participant,
      hasRemoteAudio: participant.hasRemoteAudio,
      hasRemoteVideo: participant.hasRemoteVideo,
      presenting: participant.presenting
    })),
    {
      ...me,
      hasRemoteAudio: hasLocalAudio,
      hasRemoteVideo: hasLocalVideo,
      presenting: Boolean(activeCall.presentingSource)
    }
  ] : [];
  return /* @__PURE__ */ import_react.default.createElement(import_react.default.Fragment, null, /* @__PURE__ */ import_react.default.createElement(import_CallScreen.CallScreen, {
    activeCall,
    getPresentingSources,
    getGroupCallVideoFrameSource: getGroupCallVideoFrameSourceForActiveCall,
    groupMembers,
    hangUpActiveCall,
    i18n,
    joinedAt,
    me,
    openSystemPreferencesAction,
    setGroupCallVideoRequest: setGroupCallVideoRequestForConversation,
    setLocalPreview,
    setRendererCanvas,
    setLocalAudio,
    setLocalVideo,
    setPresenting,
    stickyControls: showParticipantsList,
    switchToPresentationView,
    switchFromPresentationView,
    toggleScreenRecordingPermissionsDialog,
    toggleParticipants,
    togglePip,
    toggleSettings,
    toggleSpeakerView
  }), presentingSourcesAvailable && presentingSourcesAvailable.length ? /* @__PURE__ */ import_react.default.createElement(import_CallingSelectPresentingSourcesModal.CallingSelectPresentingSourcesModal, {
    i18n,
    presentingSourcesAvailable,
    setPresenting
  }) : null, settingsDialogOpen && renderDeviceSelection(), showParticipantsList && activeCall.callMode === import_Calling.CallMode.Group ? /* @__PURE__ */ import_react.default.createElement(import_CallingParticipantsList.CallingParticipantsList, {
    i18n,
    onClose: toggleParticipants,
    ourUuid: me.uuid,
    participants: groupCallParticipantsForParticipantsList
  }) : null, activeCall.callMode === import_Calling.CallMode.Group && activeCall.conversationsWithSafetyNumberChanges.length ? /* @__PURE__ */ import_react.default.createElement(import_SafetyNumberChangeDialog.SafetyNumberChangeDialog, {
    confirmText: i18n("continueCall"),
    contacts: activeCall.conversationsWithSafetyNumberChanges,
    getPreferredBadge,
    i18n,
    onCancel: hangUpActiveCall,
    onConfirm: () => {
      keyChangeOk({ conversationId: activeCall.conversation.id });
    },
    renderSafetyNumber: renderSafetyNumberViewer,
    theme
  }) : null);
}, "ActiveCallManager");
const CallManager = /* @__PURE__ */ __name((props) => {
  const {
    acceptCall,
    activeCall,
    bounceAppIconStart,
    bounceAppIconStop,
    declineCall,
    i18n,
    incomingCall,
    notifyForCall,
    playRingtone,
    stopRingtone,
    setIsCallActive,
    setOutgoingRing
  } = props;
  const isCallActive = Boolean(activeCall);
  (0, import_react.useEffect)(() => {
    setIsCallActive(isCallActive);
  }, [isCallActive, setIsCallActive]);
  const shouldRing = getShouldRing(props);
  (0, import_react.useEffect)(() => {
    if (shouldRing) {
      playRingtone();
      return () => {
        stopRingtone();
      };
    }
    stopRingtone();
    return import_lodash.noop;
  }, [shouldRing, playRingtone, stopRingtone]);
  const mightBeRingingOutgoingGroupCall = activeCall?.callMode === import_Calling.CallMode.Group && activeCall.outgoingRing && activeCall.joinState !== import_Calling.GroupCallJoinState.NotJoined;
  (0, import_react.useEffect)(() => {
    if (!mightBeRingingOutgoingGroupCall) {
      return import_lodash.noop;
    }
    const timeout = setTimeout(() => {
      setOutgoingRing(false);
    }, GROUP_CALL_RING_DURATION);
    return () => {
      clearTimeout(timeout);
    };
  }, [mightBeRingingOutgoingGroupCall, setOutgoingRing]);
  if (activeCall) {
    return /* @__PURE__ */ import_react.default.createElement(ActiveCallManager, {
      ...props,
      activeCall
    });
  }
  if (incomingCall) {
    return /* @__PURE__ */ import_react.default.createElement(import_IncomingCallBar.IncomingCallBar, {
      acceptCall,
      bounceAppIconStart,
      bounceAppIconStop,
      declineCall,
      i18n,
      notifyForCall,
      ...incomingCall
    });
  }
  return null;
}, "CallManager");
function getShouldRing({
  activeCall,
  incomingCall
}) {
  if (incomingCall) {
    return !activeCall;
  }
  if (!activeCall) {
    return false;
  }
  switch (activeCall.callMode) {
    case import_Calling.CallMode.Direct:
      return activeCall.callState === import_Calling.CallState.Prering || activeCall.callState === import_Calling.CallState.Ringing;
    case import_Calling.CallMode.Group:
      return activeCall.outgoingRing && (activeCall.connectionState === import_Calling.GroupCallConnectionState.Connecting || activeCall.connectionState === import_Calling.GroupCallConnectionState.Connected) && activeCall.joinState !== import_Calling.GroupCallJoinState.NotJoined && !activeCall.remoteParticipants.length && (activeCall.conversation.sortedGroupMembers || []).length >= 2;
    default:
      throw (0, import_missingCaseError.missingCaseError)(activeCall);
  }
}
// Annotate the CommonJS export names for ESM import in node:
0 && (module.exports = {
  CallManager
});
//# sourceMappingURL=data:application/json;base64,ewogICJ2ZXJzaW9uIjogMywKICAic291cmNlcyI6IFsiQ2FsbE1hbmFnZXIudHN4Il0sCiAgInNvdXJjZXNDb250ZW50IjogWyIvLyBDb3B5cmlnaHQgMjAyMC0yMDIyIFNpZ25hbCBNZXNzZW5nZXIsIExMQ1xuLy8gU1BEWC1MaWNlbnNlLUlkZW50aWZpZXI6IEFHUEwtMy4wLW9ubHlcblxuaW1wb3J0IFJlYWN0LCB7IHVzZUNhbGxiYWNrLCB1c2VFZmZlY3QgfSBmcm9tICdyZWFjdCc7XG5pbXBvcnQgeyBub29wIH0gZnJvbSAnbG9kYXNoJztcbmltcG9ydCB0eXBlIHsgVmlkZW9GcmFtZVNvdXJjZSB9IGZyb20gJ3JpbmdydGMnO1xuaW1wb3J0IHsgQ2FsbE5lZWRQZXJtaXNzaW9uU2NyZWVuIH0gZnJvbSAnLi9DYWxsTmVlZFBlcm1pc3Npb25TY3JlZW4nO1xuaW1wb3J0IHsgQ2FsbFNjcmVlbiB9IGZyb20gJy4vQ2FsbFNjcmVlbic7XG5pbXBvcnQgeyBDYWxsaW5nTG9iYnkgfSBmcm9tICcuL0NhbGxpbmdMb2JieSc7XG5pbXBvcnQgeyBDYWxsaW5nUGFydGljaXBhbnRzTGlzdCB9IGZyb20gJy4vQ2FsbGluZ1BhcnRpY2lwYW50c0xpc3QnO1xuaW1wb3J0IHsgQ2FsbGluZ1NlbGVjdFByZXNlbnRpbmdTb3VyY2VzTW9kYWwgfSBmcm9tICcuL0NhbGxpbmdTZWxlY3RQcmVzZW50aW5nU291cmNlc01vZGFsJztcbmltcG9ydCB7IENhbGxpbmdQaXAgfSBmcm9tICcuL0NhbGxpbmdQaXAnO1xuaW1wb3J0IHsgSW5jb21pbmdDYWxsQmFyIH0gZnJvbSAnLi9JbmNvbWluZ0NhbGxCYXInO1xuaW1wb3J0IHR5cGUgeyBTYWZldHlOdW1iZXJQcm9wcyB9IGZyb20gJy4vU2FmZXR5TnVtYmVyQ2hhbmdlRGlhbG9nJztcbmltcG9ydCB7IFNhZmV0eU51bWJlckNoYW5nZURpYWxvZyB9IGZyb20gJy4vU2FmZXR5TnVtYmVyQ2hhbmdlRGlhbG9nJztcbmltcG9ydCB0eXBlIHtcbiAgQWN0aXZlQ2FsbFR5cGUsXG4gIEdyb3VwQ2FsbFZpZGVvUmVxdWVzdCxcbiAgUHJlc2VudGVkU291cmNlLFxufSBmcm9tICcuLi90eXBlcy9DYWxsaW5nJztcbmltcG9ydCB7XG4gIENhbGxFbmRlZFJlYXNvbixcbiAgQ2FsbE1vZGUsXG4gIENhbGxTdGF0ZSxcbiAgR3JvdXBDYWxsQ29ubmVjdGlvblN0YXRlLFxuICBHcm91cENhbGxKb2luU3RhdGUsXG59IGZyb20gJy4uL3R5cGVzL0NhbGxpbmcnO1xuaW1wb3J0IHR5cGUgeyBDb252ZXJzYXRpb25UeXBlIH0gZnJvbSAnLi4vc3RhdGUvZHVja3MvY29udmVyc2F0aW9ucyc7XG5pbXBvcnQgdHlwZSB7IFByZWZlcnJlZEJhZGdlU2VsZWN0b3JUeXBlIH0gZnJvbSAnLi4vc3RhdGUvc2VsZWN0b3JzL2JhZGdlcyc7XG5pbXBvcnQgdHlwZSB7XG4gIEFjY2VwdENhbGxUeXBlLFxuICBDYW5jZWxDYWxsVHlwZSxcbiAgRGVjbGluZUNhbGxUeXBlLFxuICBLZXlDaGFuZ2VPa1R5cGUsXG4gIFNldEdyb3VwQ2FsbFZpZGVvUmVxdWVzdFR5cGUsXG4gIFNldExvY2FsQXVkaW9UeXBlLFxuICBTZXRMb2NhbFByZXZpZXdUeXBlLFxuICBTZXRMb2NhbFZpZGVvVHlwZSxcbiAgU2V0UmVuZGVyZXJDYW52YXNUeXBlLFxuICBTdGFydENhbGxUeXBlLFxufSBmcm9tICcuLi9zdGF0ZS9kdWNrcy9jYWxsaW5nJztcbmltcG9ydCB0eXBlIHsgTG9jYWxpemVyVHlwZSwgVGhlbWVUeXBlIH0gZnJvbSAnLi4vdHlwZXMvVXRpbCc7XG5pbXBvcnQgeyBtaXNzaW5nQ2FzZUVycm9yIH0gZnJvbSAnLi4vdXRpbC9taXNzaW5nQ2FzZUVycm9yJztcblxuY29uc3QgR1JPVVBfQ0FMTF9SSU5HX0RVUkFUSU9OID0gNjAgKiAxMDAwO1xuXG5leHBvcnQgdHlwZSBQcm9wc1R5cGUgPSB7XG4gIGFjdGl2ZUNhbGw/OiBBY3RpdmVDYWxsVHlwZTtcbiAgYXZhaWxhYmxlQ2FtZXJhczogQXJyYXk8TWVkaWFEZXZpY2VJbmZvPjtcbiAgY2FuY2VsQ2FsbDogKF86IENhbmNlbENhbGxUeXBlKSA9PiB2b2lkO1xuICBjbG9zZU5lZWRQZXJtaXNzaW9uU2NyZWVuOiAoKSA9PiB2b2lkO1xuICBnZXRHcm91cENhbGxWaWRlb0ZyYW1lU291cmNlOiAoXG4gICAgY29udmVyc2F0aW9uSWQ6IHN0cmluZyxcbiAgICBkZW11eElkOiBudW1iZXJcbiAgKSA9PiBWaWRlb0ZyYW1lU291cmNlO1xuICBnZXRQcmVmZXJyZWRCYWRnZTogUHJlZmVycmVkQmFkZ2VTZWxlY3RvclR5cGU7XG4gIGdldFByZXNlbnRpbmdTb3VyY2VzOiAoKSA9PiB2b2lkO1xuICBpbmNvbWluZ0NhbGw/OlxuICAgIHwge1xuICAgICAgICBjYWxsTW9kZTogQ2FsbE1vZGUuRGlyZWN0O1xuICAgICAgICBjb252ZXJzYXRpb246IENvbnZlcnNhdGlvblR5cGU7XG4gICAgICAgIGlzVmlkZW9DYWxsOiBib29sZWFuO1xuICAgICAgfVxuICAgIHwge1xuICAgICAgICBjYWxsTW9kZTogQ2FsbE1vZGUuR3JvdXA7XG4gICAgICAgIGNvbnZlcnNhdGlvbjogQ29udmVyc2F0aW9uVHlwZTtcbiAgICAgICAgb3RoZXJNZW1iZXJzUnVuZzogQXJyYXk8UGljazxDb252ZXJzYXRpb25UeXBlLCAnZmlyc3ROYW1lJyB8ICd0aXRsZSc+PjtcbiAgICAgICAgcmluZ2VyOiBQaWNrPENvbnZlcnNhdGlvblR5cGUsICdmaXJzdE5hbWUnIHwgJ3RpdGxlJz47XG4gICAgICB9O1xuICBrZXlDaGFuZ2VPazogKF86IEtleUNoYW5nZU9rVHlwZSkgPT4gdm9pZDtcbiAgcmVuZGVyRGV2aWNlU2VsZWN0aW9uOiAoKSA9PiBKU1guRWxlbWVudDtcbiAgcmVuZGVyU2FmZXR5TnVtYmVyVmlld2VyOiAocHJvcHM6IFNhZmV0eU51bWJlclByb3BzKSA9PiBKU1guRWxlbWVudDtcbiAgc3RhcnRDYWxsOiAocGF5bG9hZDogU3RhcnRDYWxsVHlwZSkgPT4gdm9pZDtcbiAgdG9nZ2xlUGFydGljaXBhbnRzOiAoKSA9PiB2b2lkO1xuICBhY2NlcHRDYWxsOiAoXzogQWNjZXB0Q2FsbFR5cGUpID0+IHZvaWQ7XG4gIGJvdW5jZUFwcEljb25TdGFydDogKCkgPT4gdW5rbm93bjtcbiAgYm91bmNlQXBwSWNvblN0b3A6ICgpID0+IHVua25vd247XG4gIGRlY2xpbmVDYWxsOiAoXzogRGVjbGluZUNhbGxUeXBlKSA9PiB2b2lkO1xuICBpMThuOiBMb2NhbGl6ZXJUeXBlO1xuICBpc0dyb3VwQ2FsbE91dGJvdW5kUmluZ0VuYWJsZWQ6IGJvb2xlYW47XG4gIG1lOiBDb252ZXJzYXRpb25UeXBlO1xuICBub3RpZnlGb3JDYWxsOiAodGl0bGU6IHN0cmluZywgaXNWaWRlb0NhbGw6IGJvb2xlYW4pID0+IHVua25vd247XG4gIG9wZW5TeXN0ZW1QcmVmZXJlbmNlc0FjdGlvbjogKCkgPT4gdW5rbm93bjtcbiAgcGxheVJpbmd0b25lOiAoKSA9PiB1bmtub3duO1xuICBzZXRHcm91cENhbGxWaWRlb1JlcXVlc3Q6IChfOiBTZXRHcm91cENhbGxWaWRlb1JlcXVlc3RUeXBlKSA9PiB2b2lkO1xuICBzZXRJc0NhbGxBY3RpdmU6IChfOiBib29sZWFuKSA9PiB2b2lkO1xuICBzZXRMb2NhbEF1ZGlvOiAoXzogU2V0TG9jYWxBdWRpb1R5cGUpID0+IHZvaWQ7XG4gIHNldExvY2FsVmlkZW86IChfOiBTZXRMb2NhbFZpZGVvVHlwZSkgPT4gdm9pZDtcbiAgc2V0TG9jYWxQcmV2aWV3OiAoXzogU2V0TG9jYWxQcmV2aWV3VHlwZSkgPT4gdm9pZDtcbiAgc2V0T3V0Z29pbmdSaW5nOiAoXzogYm9vbGVhbikgPT4gdm9pZDtcbiAgc2V0UHJlc2VudGluZzogKF8/OiBQcmVzZW50ZWRTb3VyY2UpID0+IHZvaWQ7XG4gIHNldFJlbmRlcmVyQ2FudmFzOiAoXzogU2V0UmVuZGVyZXJDYW52YXNUeXBlKSA9PiB2b2lkO1xuICBzdG9wUmluZ3RvbmU6ICgpID0+IHVua25vd247XG4gIHN3aXRjaFRvUHJlc2VudGF0aW9uVmlldzogKCkgPT4gdm9pZDtcbiAgc3dpdGNoRnJvbVByZXNlbnRhdGlvblZpZXc6ICgpID0+IHZvaWQ7XG4gIGhhbmdVcEFjdGl2ZUNhbGw6ICgpID0+IHZvaWQ7XG4gIHRoZW1lOiBUaGVtZVR5cGU7XG4gIHRvZ2dsZVBpcDogKCkgPT4gdm9pZDtcbiAgdG9nZ2xlU2NyZWVuUmVjb3JkaW5nUGVybWlzc2lvbnNEaWFsb2c6ICgpID0+IHVua25vd247XG4gIHRvZ2dsZVNldHRpbmdzOiAoKSA9PiB2b2lkO1xuICB0b2dnbGVTcGVha2VyVmlldzogKCkgPT4gdm9pZDtcbn07XG5cbnR5cGUgQWN0aXZlQ2FsbE1hbmFnZXJQcm9wc1R5cGUgPSBQcm9wc1R5cGUgJiB7XG4gIGFjdGl2ZUNhbGw6IEFjdGl2ZUNhbGxUeXBlO1xufTtcblxuY29uc3QgQWN0aXZlQ2FsbE1hbmFnZXI6IFJlYWN0LkZDPEFjdGl2ZUNhbGxNYW5hZ2VyUHJvcHNUeXBlPiA9ICh7XG4gIGFjdGl2ZUNhbGwsXG4gIGF2YWlsYWJsZUNhbWVyYXMsXG4gIGNhbmNlbENhbGwsXG4gIGNsb3NlTmVlZFBlcm1pc3Npb25TY3JlZW4sXG4gIGhhbmdVcEFjdGl2ZUNhbGwsXG4gIGkxOG4sXG4gIGlzR3JvdXBDYWxsT3V0Ym91bmRSaW5nRW5hYmxlZCxcbiAga2V5Q2hhbmdlT2ssXG4gIGdldEdyb3VwQ2FsbFZpZGVvRnJhbWVTb3VyY2UsXG4gIGdldFByZWZlcnJlZEJhZGdlLFxuICBnZXRQcmVzZW50aW5nU291cmNlcyxcbiAgbWUsXG4gIG9wZW5TeXN0ZW1QcmVmZXJlbmNlc0FjdGlvbixcbiAgcmVuZGVyRGV2aWNlU2VsZWN0aW9uLFxuICByZW5kZXJTYWZldHlOdW1iZXJWaWV3ZXIsXG4gIHNldEdyb3VwQ2FsbFZpZGVvUmVxdWVzdCxcbiAgc2V0TG9jYWxBdWRpbyxcbiAgc2V0TG9jYWxQcmV2aWV3LFxuICBzZXRMb2NhbFZpZGVvLFxuICBzZXRQcmVzZW50aW5nLFxuICBzZXRSZW5kZXJlckNhbnZhcyxcbiAgc2V0T3V0Z29pbmdSaW5nLFxuICBzdGFydENhbGwsXG4gIHN3aXRjaFRvUHJlc2VudGF0aW9uVmlldyxcbiAgc3dpdGNoRnJvbVByZXNlbnRhdGlvblZpZXcsXG4gIHRoZW1lLFxuICB0b2dnbGVQYXJ0aWNpcGFudHMsXG4gIHRvZ2dsZVBpcCxcbiAgdG9nZ2xlU2NyZWVuUmVjb3JkaW5nUGVybWlzc2lvbnNEaWFsb2csXG4gIHRvZ2dsZVNldHRpbmdzLFxuICB0b2dnbGVTcGVha2VyVmlldyxcbn0pID0+IHtcbiAgY29uc3Qge1xuICAgIGNvbnZlcnNhdGlvbixcbiAgICBoYXNMb2NhbEF1ZGlvLFxuICAgIGhhc0xvY2FsVmlkZW8sXG4gICAgam9pbmVkQXQsXG4gICAgcGVla2VkUGFydGljaXBhbnRzLFxuICAgIHBpcCxcbiAgICBwcmVzZW50aW5nU291cmNlc0F2YWlsYWJsZSxcbiAgICBzZXR0aW5nc0RpYWxvZ09wZW4sXG4gICAgc2hvd1BhcnRpY2lwYW50c0xpc3QsXG4gICAgb3V0Z29pbmdSaW5nLFxuICB9ID0gYWN0aXZlQ2FsbDtcblxuICBjb25zdCBjYW5jZWxBY3RpdmVDYWxsID0gdXNlQ2FsbGJhY2soKCkgPT4ge1xuICAgIGNhbmNlbENhbGwoeyBjb252ZXJzYXRpb25JZDogY29udmVyc2F0aW9uLmlkIH0pO1xuICB9LCBbY2FuY2VsQ2FsbCwgY29udmVyc2F0aW9uLmlkXSk7XG5cbiAgY29uc3Qgam9pbkFjdGl2ZUNhbGwgPSB1c2VDYWxsYmFjaygoKSA9PiB7XG4gICAgc3RhcnRDYWxsKHtcbiAgICAgIGNhbGxNb2RlOiBhY3RpdmVDYWxsLmNhbGxNb2RlLFxuICAgICAgY29udmVyc2F0aW9uSWQ6IGNvbnZlcnNhdGlvbi5pZCxcbiAgICAgIGhhc0xvY2FsQXVkaW8sXG4gICAgICBoYXNMb2NhbFZpZGVvLFxuICAgIH0pO1xuICB9LCBbXG4gICAgc3RhcnRDYWxsLFxuICAgIGFjdGl2ZUNhbGwuY2FsbE1vZGUsXG4gICAgY29udmVyc2F0aW9uLmlkLFxuICAgIGhhc0xvY2FsQXVkaW8sXG4gICAgaGFzTG9jYWxWaWRlbyxcbiAgXSk7XG5cbiAgY29uc3QgZ2V0R3JvdXBDYWxsVmlkZW9GcmFtZVNvdXJjZUZvckFjdGl2ZUNhbGwgPSB1c2VDYWxsYmFjayhcbiAgICAoZGVtdXhJZDogbnVtYmVyKSA9PiB7XG4gICAgICByZXR1cm4gZ2V0R3JvdXBDYWxsVmlkZW9GcmFtZVNvdXJjZShjb252ZXJzYXRpb24uaWQsIGRlbXV4SWQpO1xuICAgIH0sXG4gICAgW2dldEdyb3VwQ2FsbFZpZGVvRnJhbWVTb3VyY2UsIGNvbnZlcnNhdGlvbi5pZF1cbiAgKTtcblxuICBjb25zdCBzZXRHcm91cENhbGxWaWRlb1JlcXVlc3RGb3JDb252ZXJzYXRpb24gPSB1c2VDYWxsYmFjayhcbiAgICAocmVzb2x1dGlvbnM6IEFycmF5PEdyb3VwQ2FsbFZpZGVvUmVxdWVzdD4pID0+IHtcbiAgICAgIHNldEdyb3VwQ2FsbFZpZGVvUmVxdWVzdCh7XG4gICAgICAgIGNvbnZlcnNhdGlvbklkOiBjb252ZXJzYXRpb24uaWQsXG4gICAgICAgIHJlc29sdXRpb25zLFxuICAgICAgfSk7XG4gICAgfSxcbiAgICBbc2V0R3JvdXBDYWxsVmlkZW9SZXF1ZXN0LCBjb252ZXJzYXRpb24uaWRdXG4gICk7XG5cbiAgbGV0IGlzQ2FsbEZ1bGw6IGJvb2xlYW47XG4gIGxldCBzaG93Q2FsbExvYmJ5OiBib29sZWFuO1xuICBsZXQgZ3JvdXBNZW1iZXJzOlxuICAgIHwgdW5kZWZpbmVkXG4gICAgfCBBcnJheTxQaWNrPENvbnZlcnNhdGlvblR5cGUsICdpZCcgfCAnZmlyc3ROYW1lJyB8ICd0aXRsZSc+PjtcblxuICBzd2l0Y2ggKGFjdGl2ZUNhbGwuY2FsbE1vZGUpIHtcbiAgICBjYXNlIENhbGxNb2RlLkRpcmVjdDoge1xuICAgICAgY29uc3QgeyBjYWxsU3RhdGUsIGNhbGxFbmRlZFJlYXNvbiB9ID0gYWN0aXZlQ2FsbDtcbiAgICAgIGNvbnN0IGVuZGVkID0gY2FsbFN0YXRlID09PSBDYWxsU3RhdGUuRW5kZWQ7XG4gICAgICBpZiAoXG4gICAgICAgIGVuZGVkICYmXG4gICAgICAgIGNhbGxFbmRlZFJlYXNvbiA9PT0gQ2FsbEVuZGVkUmVhc29uLlJlbW90ZUhhbmd1cE5lZWRQZXJtaXNzaW9uXG4gICAgICApIHtcbiAgICAgICAgcmV0dXJuIChcbiAgICAgICAgICA8Q2FsbE5lZWRQZXJtaXNzaW9uU2NyZWVuXG4gICAgICAgICAgICBjbG9zZT17Y2xvc2VOZWVkUGVybWlzc2lvblNjcmVlbn1cbiAgICAgICAgICAgIGNvbnZlcnNhdGlvbj17Y29udmVyc2F0aW9ufVxuICAgICAgICAgICAgaTE4bj17aTE4bn1cbiAgICAgICAgICAvPlxuICAgICAgICApO1xuICAgICAgfVxuICAgICAgc2hvd0NhbGxMb2JieSA9ICFjYWxsU3RhdGU7XG4gICAgICBpc0NhbGxGdWxsID0gZmFsc2U7XG4gICAgICBncm91cE1lbWJlcnMgPSB1bmRlZmluZWQ7XG4gICAgICBicmVhaztcbiAgICB9XG4gICAgY2FzZSBDYWxsTW9kZS5Hcm91cDoge1xuICAgICAgc2hvd0NhbGxMb2JieSA9IGFjdGl2ZUNhbGwuam9pblN0YXRlICE9PSBHcm91cENhbGxKb2luU3RhdGUuSm9pbmVkO1xuICAgICAgaXNDYWxsRnVsbCA9IGFjdGl2ZUNhbGwuZGV2aWNlQ291bnQgPj0gYWN0aXZlQ2FsbC5tYXhEZXZpY2VzO1xuICAgICAgKHsgZ3JvdXBNZW1iZXJzIH0gPSBhY3RpdmVDYWxsKTtcbiAgICAgIGJyZWFrO1xuICAgIH1cbiAgICBkZWZhdWx0OlxuICAgICAgdGhyb3cgbWlzc2luZ0Nhc2VFcnJvcihhY3RpdmVDYWxsKTtcbiAgfVxuXG4gIGlmIChzaG93Q2FsbExvYmJ5KSB7XG4gICAgcmV0dXJuIChcbiAgICAgIDw+XG4gICAgICAgIDxDYWxsaW5nTG9iYnlcbiAgICAgICAgICBhdmFpbGFibGVDYW1lcmFzPXthdmFpbGFibGVDYW1lcmFzfVxuICAgICAgICAgIGNvbnZlcnNhdGlvbj17Y29udmVyc2F0aW9ufVxuICAgICAgICAgIGdyb3VwTWVtYmVycz17Z3JvdXBNZW1iZXJzfVxuICAgICAgICAgIGhhc0xvY2FsQXVkaW89e2hhc0xvY2FsQXVkaW99XG4gICAgICAgICAgaGFzTG9jYWxWaWRlbz17aGFzTG9jYWxWaWRlb31cbiAgICAgICAgICBpMThuPXtpMThufVxuICAgICAgICAgIGlzR3JvdXBDYWxsPXthY3RpdmVDYWxsLmNhbGxNb2RlID09PSBDYWxsTW9kZS5Hcm91cH1cbiAgICAgICAgICBpc0dyb3VwQ2FsbE91dGJvdW5kUmluZ0VuYWJsZWQ9e2lzR3JvdXBDYWxsT3V0Ym91bmRSaW5nRW5hYmxlZH1cbiAgICAgICAgICBpc0NhbGxGdWxsPXtpc0NhbGxGdWxsfVxuICAgICAgICAgIG1lPXttZX1cbiAgICAgICAgICBvbkNhbGxDYW5jZWxlZD17Y2FuY2VsQWN0aXZlQ2FsbH1cbiAgICAgICAgICBvbkpvaW5DYWxsPXtqb2luQWN0aXZlQ2FsbH1cbiAgICAgICAgICBvdXRnb2luZ1Jpbmc9e291dGdvaW5nUmluZ31cbiAgICAgICAgICBwZWVrZWRQYXJ0aWNpcGFudHM9e3BlZWtlZFBhcnRpY2lwYW50c31cbiAgICAgICAgICBzZXRMb2NhbFByZXZpZXc9e3NldExvY2FsUHJldmlld31cbiAgICAgICAgICBzZXRMb2NhbEF1ZGlvPXtzZXRMb2NhbEF1ZGlvfVxuICAgICAgICAgIHNldExvY2FsVmlkZW89e3NldExvY2FsVmlkZW99XG4gICAgICAgICAgc2V0T3V0Z29pbmdSaW5nPXtzZXRPdXRnb2luZ1Jpbmd9XG4gICAgICAgICAgc2hvd1BhcnRpY2lwYW50c0xpc3Q9e3Nob3dQYXJ0aWNpcGFudHNMaXN0fVxuICAgICAgICAgIHRvZ2dsZVBhcnRpY2lwYW50cz17dG9nZ2xlUGFydGljaXBhbnRzfVxuICAgICAgICAgIHRvZ2dsZVNldHRpbmdzPXt0b2dnbGVTZXR0aW5nc31cbiAgICAgICAgLz5cbiAgICAgICAge3NldHRpbmdzRGlhbG9nT3BlbiAmJiByZW5kZXJEZXZpY2VTZWxlY3Rpb24oKX1cbiAgICAgICAge3Nob3dQYXJ0aWNpcGFudHNMaXN0ICYmIGFjdGl2ZUNhbGwuY2FsbE1vZGUgPT09IENhbGxNb2RlLkdyb3VwID8gKFxuICAgICAgICAgIDxDYWxsaW5nUGFydGljaXBhbnRzTGlzdFxuICAgICAgICAgICAgaTE4bj17aTE4bn1cbiAgICAgICAgICAgIG9uQ2xvc2U9e3RvZ2dsZVBhcnRpY2lwYW50c31cbiAgICAgICAgICAgIG91clV1aWQ9e21lLnV1aWR9XG4gICAgICAgICAgICBwYXJ0aWNpcGFudHM9e3BlZWtlZFBhcnRpY2lwYW50c31cbiAgICAgICAgICAvPlxuICAgICAgICApIDogbnVsbH1cbiAgICAgIDwvPlxuICAgICk7XG4gIH1cblxuICBpZiAocGlwKSB7XG4gICAgcmV0dXJuIChcbiAgICAgIDxDYWxsaW5nUGlwXG4gICAgICAgIGFjdGl2ZUNhbGw9e2FjdGl2ZUNhbGx9XG4gICAgICAgIGdldEdyb3VwQ2FsbFZpZGVvRnJhbWVTb3VyY2U9e2dldEdyb3VwQ2FsbFZpZGVvRnJhbWVTb3VyY2VGb3JBY3RpdmVDYWxsfVxuICAgICAgICBoYW5nVXBBY3RpdmVDYWxsPXtoYW5nVXBBY3RpdmVDYWxsfVxuICAgICAgICBoYXNMb2NhbFZpZGVvPXtoYXNMb2NhbFZpZGVvfVxuICAgICAgICBpMThuPXtpMThufVxuICAgICAgICBzZXRHcm91cENhbGxWaWRlb1JlcXVlc3Q9e3NldEdyb3VwQ2FsbFZpZGVvUmVxdWVzdEZvckNvbnZlcnNhdGlvbn1cbiAgICAgICAgc2V0TG9jYWxQcmV2aWV3PXtzZXRMb2NhbFByZXZpZXd9XG4gICAgICAgIHNldFJlbmRlcmVyQ2FudmFzPXtzZXRSZW5kZXJlckNhbnZhc31cbiAgICAgICAgc3dpdGNoVG9QcmVzZW50YXRpb25WaWV3PXtzd2l0Y2hUb1ByZXNlbnRhdGlvblZpZXd9XG4gICAgICAgIHN3aXRjaEZyb21QcmVzZW50YXRpb25WaWV3PXtzd2l0Y2hGcm9tUHJlc2VudGF0aW9uVmlld31cbiAgICAgICAgdG9nZ2xlUGlwPXt0b2dnbGVQaXB9XG4gICAgICAvPlxuICAgICk7XG4gIH1cblxuICBjb25zdCBncm91cENhbGxQYXJ0aWNpcGFudHNGb3JQYXJ0aWNpcGFudHNMaXN0ID1cbiAgICBhY3RpdmVDYWxsLmNhbGxNb2RlID09PSBDYWxsTW9kZS5Hcm91cFxuICAgICAgPyBbXG4gICAgICAgICAgLi4uYWN0aXZlQ2FsbC5yZW1vdGVQYXJ0aWNpcGFudHMubWFwKHBhcnRpY2lwYW50ID0+ICh7XG4gICAgICAgICAgICAuLi5wYXJ0aWNpcGFudCxcbiAgICAgICAgICAgIGhhc1JlbW90ZUF1ZGlvOiBwYXJ0aWNpcGFudC5oYXNSZW1vdGVBdWRpbyxcbiAgICAgICAgICAgIGhhc1JlbW90ZVZpZGVvOiBwYXJ0aWNpcGFudC5oYXNSZW1vdGVWaWRlbyxcbiAgICAgICAgICAgIHByZXNlbnRpbmc6IHBhcnRpY2lwYW50LnByZXNlbnRpbmcsXG4gICAgICAgICAgfSkpLFxuICAgICAgICAgIHtcbiAgICAgICAgICAgIC4uLm1lLFxuICAgICAgICAgICAgaGFzUmVtb3RlQXVkaW86IGhhc0xvY2FsQXVkaW8sXG4gICAgICAgICAgICBoYXNSZW1vdGVWaWRlbzogaGFzTG9jYWxWaWRlbyxcbiAgICAgICAgICAgIHByZXNlbnRpbmc6IEJvb2xlYW4oYWN0aXZlQ2FsbC5wcmVzZW50aW5nU291cmNlKSxcbiAgICAgICAgICB9LFxuICAgICAgICBdXG4gICAgICA6IFtdO1xuXG4gIHJldHVybiAoXG4gICAgPD5cbiAgICAgIDxDYWxsU2NyZWVuXG4gICAgICAgIGFjdGl2ZUNhbGw9e2FjdGl2ZUNhbGx9XG4gICAgICAgIGdldFByZXNlbnRpbmdTb3VyY2VzPXtnZXRQcmVzZW50aW5nU291cmNlc31cbiAgICAgICAgZ2V0R3JvdXBDYWxsVmlkZW9GcmFtZVNvdXJjZT17Z2V0R3JvdXBDYWxsVmlkZW9GcmFtZVNvdXJjZUZvckFjdGl2ZUNhbGx9XG4gICAgICAgIGdyb3VwTWVtYmVycz17Z3JvdXBNZW1iZXJzfVxuICAgICAgICBoYW5nVXBBY3RpdmVDYWxsPXtoYW5nVXBBY3RpdmVDYWxsfVxuICAgICAgICBpMThuPXtpMThufVxuICAgICAgICBqb2luZWRBdD17am9pbmVkQXR9XG4gICAgICAgIG1lPXttZX1cbiAgICAgICAgb3BlblN5c3RlbVByZWZlcmVuY2VzQWN0aW9uPXtvcGVuU3lzdGVtUHJlZmVyZW5jZXNBY3Rpb259XG4gICAgICAgIHNldEdyb3VwQ2FsbFZpZGVvUmVxdWVzdD17c2V0R3JvdXBDYWxsVmlkZW9SZXF1ZXN0Rm9yQ29udmVyc2F0aW9ufVxuICAgICAgICBzZXRMb2NhbFByZXZpZXc9e3NldExvY2FsUHJldmlld31cbiAgICAgICAgc2V0UmVuZGVyZXJDYW52YXM9e3NldFJlbmRlcmVyQ2FudmFzfVxuICAgICAgICBzZXRMb2NhbEF1ZGlvPXtzZXRMb2NhbEF1ZGlvfVxuICAgICAgICBzZXRMb2NhbFZpZGVvPXtzZXRMb2NhbFZpZGVvfVxuICAgICAgICBzZXRQcmVzZW50aW5nPXtzZXRQcmVzZW50aW5nfVxuICAgICAgICBzdGlja3lDb250cm9scz17c2hvd1BhcnRpY2lwYW50c0xpc3R9XG4gICAgICAgIHN3aXRjaFRvUHJlc2VudGF0aW9uVmlldz17c3dpdGNoVG9QcmVzZW50YXRpb25WaWV3fVxuICAgICAgICBzd2l0Y2hGcm9tUHJlc2VudGF0aW9uVmlldz17c3dpdGNoRnJvbVByZXNlbnRhdGlvblZpZXd9XG4gICAgICAgIHRvZ2dsZVNjcmVlblJlY29yZGluZ1Blcm1pc3Npb25zRGlhbG9nPXtcbiAgICAgICAgICB0b2dnbGVTY3JlZW5SZWNvcmRpbmdQZXJtaXNzaW9uc0RpYWxvZ1xuICAgICAgICB9XG4gICAgICAgIHRvZ2dsZVBhcnRpY2lwYW50cz17dG9nZ2xlUGFydGljaXBhbnRzfVxuICAgICAgICB0b2dnbGVQaXA9e3RvZ2dsZVBpcH1cbiAgICAgICAgdG9nZ2xlU2V0dGluZ3M9e3RvZ2dsZVNldHRpbmdzfVxuICAgICAgICB0b2dnbGVTcGVha2VyVmlldz17dG9nZ2xlU3BlYWtlclZpZXd9XG4gICAgICAvPlxuICAgICAge3ByZXNlbnRpbmdTb3VyY2VzQXZhaWxhYmxlICYmIHByZXNlbnRpbmdTb3VyY2VzQXZhaWxhYmxlLmxlbmd0aCA/IChcbiAgICAgICAgPENhbGxpbmdTZWxlY3RQcmVzZW50aW5nU291cmNlc01vZGFsXG4gICAgICAgICAgaTE4bj17aTE4bn1cbiAgICAgICAgICBwcmVzZW50aW5nU291cmNlc0F2YWlsYWJsZT17cHJlc2VudGluZ1NvdXJjZXNBdmFpbGFibGV9XG4gICAgICAgICAgc2V0UHJlc2VudGluZz17c2V0UHJlc2VudGluZ31cbiAgICAgICAgLz5cbiAgICAgICkgOiBudWxsfVxuICAgICAge3NldHRpbmdzRGlhbG9nT3BlbiAmJiByZW5kZXJEZXZpY2VTZWxlY3Rpb24oKX1cbiAgICAgIHtzaG93UGFydGljaXBhbnRzTGlzdCAmJiBhY3RpdmVDYWxsLmNhbGxNb2RlID09PSBDYWxsTW9kZS5Hcm91cCA/IChcbiAgICAgICAgPENhbGxpbmdQYXJ0aWNpcGFudHNMaXN0XG4gICAgICAgICAgaTE4bj17aTE4bn1cbiAgICAgICAgICBvbkNsb3NlPXt0b2dnbGVQYXJ0aWNpcGFudHN9XG4gICAgICAgICAgb3VyVXVpZD17bWUudXVpZH1cbiAgICAgICAgICBwYXJ0aWNpcGFudHM9e2dyb3VwQ2FsbFBhcnRpY2lwYW50c0ZvclBhcnRpY2lwYW50c0xpc3R9XG4gICAgICAgIC8+XG4gICAgICApIDogbnVsbH1cbiAgICAgIHthY3RpdmVDYWxsLmNhbGxNb2RlID09PSBDYWxsTW9kZS5Hcm91cCAmJlxuICAgICAgYWN0aXZlQ2FsbC5jb252ZXJzYXRpb25zV2l0aFNhZmV0eU51bWJlckNoYW5nZXMubGVuZ3RoID8gKFxuICAgICAgICA8U2FmZXR5TnVtYmVyQ2hhbmdlRGlhbG9nXG4gICAgICAgICAgY29uZmlybVRleHQ9e2kxOG4oJ2NvbnRpbnVlQ2FsbCcpfVxuICAgICAgICAgIGNvbnRhY3RzPXthY3RpdmVDYWxsLmNvbnZlcnNhdGlvbnNXaXRoU2FmZXR5TnVtYmVyQ2hhbmdlc31cbiAgICAgICAgICBnZXRQcmVmZXJyZWRCYWRnZT17Z2V0UHJlZmVycmVkQmFkZ2V9XG4gICAgICAgICAgaTE4bj17aTE4bn1cbiAgICAgICAgICBvbkNhbmNlbD17aGFuZ1VwQWN0aXZlQ2FsbH1cbiAgICAgICAgICBvbkNvbmZpcm09eygpID0+IHtcbiAgICAgICAgICAgIGtleUNoYW5nZU9rKHsgY29udmVyc2F0aW9uSWQ6IGFjdGl2ZUNhbGwuY29udmVyc2F0aW9uLmlkIH0pO1xuICAgICAgICAgIH19XG4gICAgICAgICAgcmVuZGVyU2FmZXR5TnVtYmVyPXtyZW5kZXJTYWZldHlOdW1iZXJWaWV3ZXJ9XG4gICAgICAgICAgdGhlbWU9e3RoZW1lfVxuICAgICAgICAvPlxuICAgICAgKSA6IG51bGx9XG4gICAgPC8+XG4gICk7XG59O1xuXG5leHBvcnQgY29uc3QgQ2FsbE1hbmFnZXI6IFJlYWN0LkZDPFByb3BzVHlwZT4gPSBwcm9wcyA9PiB7XG4gIGNvbnN0IHtcbiAgICBhY2NlcHRDYWxsLFxuICAgIGFjdGl2ZUNhbGwsXG4gICAgYm91bmNlQXBwSWNvblN0YXJ0LFxuICAgIGJvdW5jZUFwcEljb25TdG9wLFxuICAgIGRlY2xpbmVDYWxsLFxuICAgIGkxOG4sXG4gICAgaW5jb21pbmdDYWxsLFxuICAgIG5vdGlmeUZvckNhbGwsXG4gICAgcGxheVJpbmd0b25lLFxuICAgIHN0b3BSaW5ndG9uZSxcbiAgICBzZXRJc0NhbGxBY3RpdmUsXG4gICAgc2V0T3V0Z29pbmdSaW5nLFxuICB9ID0gcHJvcHM7XG5cbiAgY29uc3QgaXNDYWxsQWN0aXZlID0gQm9vbGVhbihhY3RpdmVDYWxsKTtcbiAgdXNlRWZmZWN0KCgpID0+IHtcbiAgICBzZXRJc0NhbGxBY3RpdmUoaXNDYWxsQWN0aXZlKTtcbiAgfSwgW2lzQ2FsbEFjdGl2ZSwgc2V0SXNDYWxsQWN0aXZlXSk7XG5cbiAgY29uc3Qgc2hvdWxkUmluZyA9IGdldFNob3VsZFJpbmcocHJvcHMpO1xuICB1c2VFZmZlY3QoKCkgPT4ge1xuICAgIGlmIChzaG91bGRSaW5nKSB7XG4gICAgICBwbGF5UmluZ3RvbmUoKTtcbiAgICAgIHJldHVybiAoKSA9PiB7XG4gICAgICAgIHN0b3BSaW5ndG9uZSgpO1xuICAgICAgfTtcbiAgICB9XG5cbiAgICBzdG9wUmluZ3RvbmUoKTtcbiAgICByZXR1cm4gbm9vcDtcbiAgfSwgW3Nob3VsZFJpbmcsIHBsYXlSaW5ndG9uZSwgc3RvcFJpbmd0b25lXSk7XG5cbiAgY29uc3QgbWlnaHRCZVJpbmdpbmdPdXRnb2luZ0dyb3VwQ2FsbCA9XG4gICAgYWN0aXZlQ2FsbD8uY2FsbE1vZGUgPT09IENhbGxNb2RlLkdyb3VwICYmXG4gICAgYWN0aXZlQ2FsbC5vdXRnb2luZ1JpbmcgJiZcbiAgICBhY3RpdmVDYWxsLmpvaW5TdGF0ZSAhPT0gR3JvdXBDYWxsSm9pblN0YXRlLk5vdEpvaW5lZDtcbiAgdXNlRWZmZWN0KCgpID0+IHtcbiAgICBpZiAoIW1pZ2h0QmVSaW5naW5nT3V0Z29pbmdHcm91cENhbGwpIHtcbiAgICAgIHJldHVybiBub29wO1xuICAgIH1cblxuICAgIGNvbnN0IHRpbWVvdXQgPSBzZXRUaW1lb3V0KCgpID0+IHtcbiAgICAgIHNldE91dGdvaW5nUmluZyhmYWxzZSk7XG4gICAgfSwgR1JPVVBfQ0FMTF9SSU5HX0RVUkFUSU9OKTtcbiAgICByZXR1cm4gKCkgPT4ge1xuICAgICAgY2xlYXJUaW1lb3V0KHRpbWVvdXQpO1xuICAgIH07XG4gIH0sIFttaWdodEJlUmluZ2luZ091dGdvaW5nR3JvdXBDYWxsLCBzZXRPdXRnb2luZ1JpbmddKTtcblxuICBpZiAoYWN0aXZlQ2FsbCkge1xuICAgIC8vIGBwcm9wc2Agc2hvdWxkIGxvZ2ljYWxseSBoYXZlIGFuIGBhY3RpdmVDYWxsYCBhdCB0aGlzIHBvaW50LCBidXQgVHlwZVNjcmlwdCBjYW4ndFxuICAgIC8vICAgZmlndXJlIHRoYXQgb3V0LCBzbyB3ZSBwYXNzIGl0IGluIGFnYWluLlxuICAgIHJldHVybiA8QWN0aXZlQ2FsbE1hbmFnZXIgey4uLnByb3BzfSBhY3RpdmVDYWxsPXthY3RpdmVDYWxsfSAvPjtcbiAgfVxuXG4gIC8vIEluIHRoZSBmdXR1cmUsIHdlIG1heSB3YW50IHRvIHNob3cgdGhlIGluY29taW5nIGNhbGwgYmFyIHdoZW4gYSBjYWxsIGlzIGFjdGl2ZS5cbiAgaWYgKGluY29taW5nQ2FsbCkge1xuICAgIHJldHVybiAoXG4gICAgICA8SW5jb21pbmdDYWxsQmFyXG4gICAgICAgIGFjY2VwdENhbGw9e2FjY2VwdENhbGx9XG4gICAgICAgIGJvdW5jZUFwcEljb25TdGFydD17Ym91bmNlQXBwSWNvblN0YXJ0fVxuICAgICAgICBib3VuY2VBcHBJY29uU3RvcD17Ym91bmNlQXBwSWNvblN0b3B9XG4gICAgICAgIGRlY2xpbmVDYWxsPXtkZWNsaW5lQ2FsbH1cbiAgICAgICAgaTE4bj17aTE4bn1cbiAgICAgICAgbm90aWZ5Rm9yQ2FsbD17bm90aWZ5Rm9yQ2FsbH1cbiAgICAgICAgey4uLmluY29taW5nQ2FsbH1cbiAgICAgIC8+XG4gICAgKTtcbiAgfVxuXG4gIHJldHVybiBudWxsO1xufTtcblxuZnVuY3Rpb24gZ2V0U2hvdWxkUmluZyh7XG4gIGFjdGl2ZUNhbGwsXG4gIGluY29taW5nQ2FsbCxcbn06IFJlYWRvbmx5PFBpY2s8UHJvcHNUeXBlLCAnYWN0aXZlQ2FsbCcgfCAnaW5jb21pbmdDYWxsJz4+KTogYm9vbGVhbiB7XG4gIGlmIChpbmNvbWluZ0NhbGwpIHtcbiAgICByZXR1cm4gIWFjdGl2ZUNhbGw7XG4gIH1cblxuICBpZiAoIWFjdGl2ZUNhbGwpIHtcbiAgICByZXR1cm4gZmFsc2U7XG4gIH1cblxuICBzd2l0Y2ggKGFjdGl2ZUNhbGwuY2FsbE1vZGUpIHtcbiAgICBjYXNlIENhbGxNb2RlLkRpcmVjdDpcbiAgICAgIHJldHVybiAoXG4gICAgICAgIGFjdGl2ZUNhbGwuY2FsbFN0YXRlID09PSBDYWxsU3RhdGUuUHJlcmluZyB8fFxuICAgICAgICBhY3RpdmVDYWxsLmNhbGxTdGF0ZSA9PT0gQ2FsbFN0YXRlLlJpbmdpbmdcbiAgICAgICk7XG4gICAgY2FzZSBDYWxsTW9kZS5Hcm91cDpcbiAgICAgIHJldHVybiAoXG4gICAgICAgIGFjdGl2ZUNhbGwub3V0Z29pbmdSaW5nICYmXG4gICAgICAgIChhY3RpdmVDYWxsLmNvbm5lY3Rpb25TdGF0ZSA9PT0gR3JvdXBDYWxsQ29ubmVjdGlvblN0YXRlLkNvbm5lY3RpbmcgfHxcbiAgICAgICAgICBhY3RpdmVDYWxsLmNvbm5lY3Rpb25TdGF0ZSA9PT0gR3JvdXBDYWxsQ29ubmVjdGlvblN0YXRlLkNvbm5lY3RlZCkgJiZcbiAgICAgICAgYWN0aXZlQ2FsbC5qb2luU3RhdGUgIT09IEdyb3VwQ2FsbEpvaW5TdGF0ZS5Ob3RKb2luZWQgJiZcbiAgICAgICAgIWFjdGl2ZUNhbGwucmVtb3RlUGFydGljaXBhbnRzLmxlbmd0aCAmJlxuICAgICAgICAoYWN0aXZlQ2FsbC5jb252ZXJzYXRpb24uc29ydGVkR3JvdXBNZW1iZXJzIHx8IFtdKS5sZW5ndGggPj0gMlxuICAgICAgKTtcbiAgICBkZWZhdWx0OlxuICAgICAgdGhyb3cgbWlzc2luZ0Nhc2VFcnJvcihhY3RpdmVDYWxsKTtcbiAgfVxufVxuIl0sCiAgIm1hcHBpbmdzIjogIjs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBQUE7QUFBQTtBQUFBO0FBQUE7QUFBQTtBQUdBLG1CQUE4QztBQUM5QyxvQkFBcUI7QUFFckIsc0NBQXlDO0FBQ3pDLHdCQUEyQjtBQUMzQiwwQkFBNkI7QUFDN0IscUNBQXdDO0FBQ3hDLGlEQUFvRDtBQUNwRCx3QkFBMkI7QUFDM0IsNkJBQWdDO0FBRWhDLHNDQUF5QztBQU16QyxxQkFNTztBQWdCUCw4QkFBaUM7QUFFakMsTUFBTSwyQkFBMkIsS0FBSztBQStEdEMsTUFBTSxvQkFBMEQsd0JBQUM7QUFBQSxFQUMvRDtBQUFBLEVBQ0E7QUFBQSxFQUNBO0FBQUEsRUFDQTtBQUFBLEVBQ0E7QUFBQSxFQUNBO0FBQUEsRUFDQTtBQUFBLEVBQ0E7QUFBQSxFQUNBO0FBQUEsRUFDQTtBQUFBLEVBQ0E7QUFBQSxFQUNBO0FBQUEsRUFDQTtBQUFBLEVB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
