var __defProp = Object.defineProperty;
var __getOwnPropDesc = Object.getOwnPropertyDescriptor;
var __getOwnPropNames = Object.getOwnPropertyNames;
var __hasOwnProp = Object.prototype.hasOwnProperty;
var __name = (target, value) => __defProp(target, "name", { value, configurable: true });
var __export = (target, all) => {
  for (var name in all)
    __defProp(target, name, { get: all[name], enumerable: true });
};
var __copyProps = (to, from, except, desc) => {
  if (from && typeof from === "object" || typeof from === "function") {
    for (let key of __getOwnPropNames(from))
      if (!__hasOwnProp.call(to, key) && key !== except)
        __defProp(to, key, { get: () => from[key], enumerable: !(desc = __getOwnPropDesc(from, key)) || desc.enumerable });
  }
  return to;
};
var __toCommonJS = (mod) => __copyProps(__defProp({}, "__esModule", { value: true }), mod);
var migrateLegacySendAttributes_exports = {};
__export(migrateLegacySendAttributes_exports, {
  migrateLegacySendAttributes: () => migrateLegacySendAttributes
});
module.exports = __toCommonJS(migrateLegacySendAttributes_exports);
var import_lodash = require("lodash");
var import_getOwn = require("../util/getOwn");
var import_iterables = require("../util/iterables");
var import_message = require("../state/selectors/message");
var import_MessageSendState = require("./MessageSendState");
function migrateLegacySendAttributes(message, getConversation, ourConversationId) {
  const shouldMigrate = (0, import_lodash.isEmpty)(message.sendStateByConversationId) && (0, import_message.isOutgoing)(message);
  if (!shouldMigrate) {
    return void 0;
  }
  const pendingSendState = {
    status: import_MessageSendState.SendStatus.Pending,
    updatedAt: message.sent_at
  };
  const sendStateByConversationId = (0, import_iterables.zipObject)(getConversationIdsFromLegacyAttribute(message, "recipients", getConversation), (0, import_iterables.repeat)(pendingSendState));
  const wasSentToSelf = Boolean((0, import_lodash.get)(message, "sent"));
  const actions = (0, import_iterables.concat)((0, import_iterables.map)(getConversationIdsFromErrors(message.errors, getConversation), (conversationId) => ({
    type: import_MessageSendState.SendActionType.Failed,
    conversationId
  })), (0, import_iterables.map)(getConversationIdsFromLegacyAttribute(message, "sent_to", getConversation), (conversationId) => ({
    type: import_MessageSendState.SendActionType.Sent,
    conversationId
  })), (0, import_iterables.map)(getConversationIdsFromLegacyAttribute(message, "delivered_to", getConversation), (conversationId) => ({
    type: import_MessageSendState.SendActionType.GotDeliveryReceipt,
    conversationId
  })), (0, import_iterables.map)(getConversationIdsFromLegacyAttribute(message, "read_by", getConversation), (conversationId) => ({
    type: import_MessageSendState.SendActionType.GotReadReceipt,
    conversationId
  })), [
    {
      type: wasSentToSelf ? import_MessageSendState.SendActionType.Sent : import_MessageSendState.SendActionType.Failed,
      conversationId: ourConversationId
    }
  ]);
  for (const { conversationId, type } of actions) {
    const oldSendState = (0, import_getOwn.getOwn)(sendStateByConversationId, conversationId) || pendingSendState;
    sendStateByConversationId[conversationId] = (0, import_MessageSendState.sendStateReducer)(oldSendState, {
      type,
      updatedAt: void 0
    });
  }
  return sendStateByConversationId;
}
function getConversationIdsFromErrors(errors, getConversation) {
  const result = [];
  (errors || []).forEach((error) => {
    const conversation = getConversation(error.identifier) || getConversation(error.number);
    if (conversation) {
      result.push(conversation.id);
    }
  });
  return result;
}
function getConversationIdsFromLegacyAttribute(message, attributeName, getConversation) {
  const rawValue = message[attributeName];
  const value = Array.isArray(rawValue) ? rawValue : [];
  const result = [];
  value.forEach((identifier) => {
    if (typeof identifier !== "string") {
      return;
    }
    const conversation = getConversation(identifier);
    if (conversation) {
      result.push(conversation.id);
    }
  });
  return result;
}
// Annotate the CommonJS export names for ESM import in node:
0 && (module.exports = {
  migrateLegacySendAttributes
});
//# sourceMappingURL=data:application/json;base64,ewogICJ2ZXJzaW9uIjogMywKICAic291cmNlcyI6IFsibWlncmF0ZUxlZ2FjeVNlbmRBdHRyaWJ1dGVzLnRzIl0sCiAgInNvdXJjZXNDb250ZW50IjogWyIvLyBDb3B5cmlnaHQgMjAyMSBTaWduYWwgTWVzc2VuZ2VyLCBMTENcbi8vIFNQRFgtTGljZW5zZS1JZGVudGlmaWVyOiBBR1BMLTMuMC1vbmx5XG5cbmltcG9ydCB7IGdldCwgaXNFbXB0eSB9IGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgeyBnZXRPd24gfSBmcm9tICcuLi91dGlsL2dldE93bic7XG5pbXBvcnQgeyBtYXAsIGNvbmNhdCwgcmVwZWF0LCB6aXBPYmplY3QgfSBmcm9tICcuLi91dGlsL2l0ZXJhYmxlcyc7XG5pbXBvcnQgeyBpc091dGdvaW5nIH0gZnJvbSAnLi4vc3RhdGUvc2VsZWN0b3JzL21lc3NhZ2UnO1xuaW1wb3J0IHR5cGUgeyBDdXN0b21FcnJvciwgTWVzc2FnZUF0dHJpYnV0ZXNUeXBlIH0gZnJvbSAnLi4vbW9kZWwtdHlwZXMuZCc7XG5pbXBvcnQgdHlwZSB7IFNlbmRTdGF0ZSwgU2VuZFN0YXRlQnlDb252ZXJzYXRpb25JZCB9IGZyb20gJy4vTWVzc2FnZVNlbmRTdGF0ZSc7XG5pbXBvcnQge1xuICBTZW5kQWN0aW9uVHlwZSxcbiAgc2VuZFN0YXRlUmVkdWNlcixcbiAgU2VuZFN0YXR1cyxcbn0gZnJvbSAnLi9NZXNzYWdlU2VuZFN0YXRlJztcblxuLyoqXG4gKiBUaGlzIGNvbnZlcnRzIGxlZ2FjeSBtZXNzYWdlIGZpZWxkcywgc3VjaCBhcyBgc2VudF90b2AsIGludG8gdGhlIG5ld1xuICogYHNlbmRTdGF0ZUJ5Q29udmVyc2F0aW9uSWRgIGZvcm1hdC4gVGhlc2UgbGVnYWN5IGZpZWxkcyBhcmVuJ3QgdHlwZWQgdG8gcHJldmVudCB0aGVpclxuICogdXNhZ2UsIHNvIHdlIHRyZWF0IHRoZW0gY2FyZWZ1bGx5IChpLmUuLCBhcyBpZiB0aGV5IGFyZSBgdW5rbm93bmApLlxuICpcbiAqIE9sZCBkYXRhIGlzbid0IGRyb3BwZWQsIGluIGNhc2Ugd2UgbmVlZCB0byByZXZlcnQgdGhpcyBjaGFuZ2UuIFdlIHNob3VsZCBzYWZlbHkgYmUgYWJsZVxuICogdG8gcmVtb3ZlIHRoZSBmb2xsb3dpbmcgYXR0cmlidXRlcyBvbmNlIHdlJ3JlIGNvbmZpZGVudCBpbiB0aGlzIG5ldyBmb3JtYXQ6XG4gKlxuICogLSBkZWxpdmVyZWRcbiAqIC0gZGVsaXZlcmVkX3RvXG4gKiAtIHJlYWRfYnlcbiAqIC0gcmVjaXBpZW50c1xuICogLSBzZW50XG4gKiAtIHNlbnRfdG9cbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIG1pZ3JhdGVMZWdhY3lTZW5kQXR0cmlidXRlcyhcbiAgbWVzc2FnZTogUmVhZG9ubHk8XG4gICAgUGljazxcbiAgICAgIE1lc3NhZ2VBdHRyaWJ1dGVzVHlwZSxcbiAgICAgICdlcnJvcnMnIHwgJ3NlbmRTdGF0ZUJ5Q29udmVyc2F0aW9uSWQnIHwgJ3NlbnRfYXQnIHwgJ3R5cGUnXG4gICAgPlxuICA+LFxuICBnZXRDb252ZXJzYXRpb246IEdldENvbnZlcnNhdGlvblR5cGUsXG4gIG91ckNvbnZlcnNhdGlvbklkOiBzdHJpbmdcbik6IHVuZGVmaW5lZCB8IFNlbmRTdGF0ZUJ5Q29udmVyc2F0aW9uSWQge1xuICBjb25zdCBzaG91bGRNaWdyYXRlID1cbiAgICBpc0VtcHR5KG1lc3NhZ2Uuc2VuZFN0YXRlQnlDb252ZXJzYXRpb25JZCkgJiYgaXNPdXRnb2luZyhtZXNzYWdlKTtcbiAgaWYgKCFzaG91bGRNaWdyYXRlKSB7XG4gICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgfVxuXG4gIGNvbnN0IHBlbmRpbmdTZW5kU3RhdGU6IFNlbmRTdGF0ZSA9IHtcbiAgICBzdGF0dXM6IFNlbmRTdGF0dXMuUGVuZGluZyxcbiAgICB1cGRhdGVkQXQ6IG1lc3NhZ2Uuc2VudF9hdCxcbiAgfTtcblxuICBjb25zdCBzZW5kU3RhdGVCeUNvbnZlcnNhdGlvbklkOiBTZW5kU3RhdGVCeUNvbnZlcnNhdGlvbklkID0gemlwT2JqZWN0KFxuICAgIGdldENvbnZlcnNhdGlvbklkc0Zyb21MZWdhY3lBdHRyaWJ1dGUoXG4gICAgICBtZXNzYWdlLFxuICAgICAgJ3JlY2lwaWVudHMnLFxuICAgICAgZ2V0Q29udmVyc2F0aW9uXG4gICAgKSxcbiAgICByZXBlYXQocGVuZGluZ1NlbmRTdGF0ZSlcbiAgKTtcblxuICAvLyBXZSB1c2UgYGdldGAgYmVjYXVzZSBgc2VudGAgaXMgYSBsZWdhY3ksIGFuZCB0aGVyZWZvcmUgdW50eXBlZCwgYXR0cmlidXRlLlxuICBjb25zdCB3YXNTZW50VG9TZWxmID0gQm9vbGVhbihnZXQobWVzc2FnZSwgJ3NlbnQnKSk7XG5cbiAgY29uc3QgYWN0aW9ucyA9IGNvbmNhdDx7XG4gICAgdHlwZTpcbiAgICAgIHwgU2VuZEFjdGlvblR5cGUuRmFpbGVkXG4gICAgICB8IFNlbmRBY3Rpb25UeXBlLlNlbnRcbiAgICAgIHwgU2VuZEFjdGlvblR5cGUuR290RGVsaXZlcnlSZWNlaXB0XG4gICAgICB8IFNlbmRBY3Rpb25UeXBlLkdvdFJlYWRSZWNlaXB0O1xuICAgIGNvbnZlcnNhdGlvbklkOiBzdHJpbmc7XG4gIH0+KFxuICAgIG1hcChcbiAgICAgIGdldENvbnZlcnNhdGlvbklkc0Zyb21FcnJvcnMobWVzc2FnZS5lcnJvcnMsIGdldENvbnZlcnNhdGlvbiksXG4gICAgICBjb252ZXJzYXRpb25JZCA9PiAoe1xuICAgICAgICB0eXBlOiBTZW5kQWN0aW9uVHlwZS5GYWlsZWQsXG4gICAgICAgIGNvbnZlcnNhdGlvbklkLFxuICAgICAgfSlcbiAgICApLFxuICAgIG1hcChcbiAgICAgIGdldENvbnZlcnNhdGlvbklkc0Zyb21MZWdhY3lBdHRyaWJ1dGUoXG4gICAgICAgIG1lc3NhZ2UsXG4gICAgICAgICdzZW50X3RvJyxcbiAgICAgICAgZ2V0Q29udmVyc2F0aW9uXG4gICAgICApLFxuICAgICAgY29udmVyc2F0aW9uSWQgPT4gKHtcbiAgICAgICAgdHlwZTogU2VuZEFjdGlvblR5cGUuU2VudCxcbiAgICAgICAgY29udmVyc2F0aW9uSWQsXG4gICAgICB9KVxuICAgICksXG4gICAgbWFwKFxuICAgICAgZ2V0Q29udmVyc2F0aW9uSWRzRnJvbUxlZ2FjeUF0dHJpYnV0ZShcbiAgICAgICAgbWVzc2FnZSxcbiAgICAgICAgJ2RlbGl2ZXJlZF90bycsXG4gICAgICAgIGdldENvbnZlcnNhdGlvblxuICAgICAgKSxcbiAgICAgIGNvbnZlcnNhdGlvbklkID0+ICh7XG4gICAgICAgIHR5cGU6IFNlbmRBY3Rpb25UeXBlLkdvdERlbGl2ZXJ5UmVjZWlwdCxcbiAgICAgICAgY29udmVyc2F0aW9uSWQsXG4gICAgICB9KVxuICAgICksXG4gICAgbWFwKFxuICAgICAgZ2V0Q29udmVyc2F0aW9uSWRzRnJvbUxlZ2FjeUF0dHJpYnV0ZShcbiAgICAgICAgbWVzc2FnZSxcbiAgICAgICAgJ3JlYWRfYnknLFxuICAgICAgICBnZXRDb252ZXJzYXRpb25cbiAgICAgICksXG4gICAgICBjb252ZXJzYXRpb25JZCA9PiAoe1xuICAgICAgICB0eXBlOiBTZW5kQWN0aW9uVHlwZS5Hb3RSZWFkUmVjZWlwdCxcbiAgICAgICAgY29udmVyc2F0aW9uSWQsXG4gICAgICB9KVxuICAgICksXG4gICAgW1xuICAgICAge1xuICAgICAgICB0eXBlOiB3YXNTZW50VG9TZWxmID8gU2VuZEFjdGlvblR5cGUuU2VudCA6IFNlbmRBY3Rpb25UeXBlLkZhaWxlZCxcbiAgICAgICAgY29udmVyc2F0aW9uSWQ6IG91ckNvbnZlcnNhdGlvbklkLFxuICAgICAgfSxcbiAgICBdXG4gICk7XG5cbiAgZm9yIChjb25zdCB7IGNvbnZlcnNhdGlvbklkLCB0eXBlIH0gb2YgYWN0aW9ucykge1xuICAgIGNvbnN0IG9sZFNlbmRTdGF0ZSA9XG4gICAgICBnZXRPd24oc2VuZFN0YXRlQnlDb252ZXJzYXRpb25JZCwgY29udmVyc2F0aW9uSWQpIHx8IHBlbmRpbmdTZW5kU3RhdGU7XG4gICAgc2VuZFN0YXRlQnlDb252ZXJzYXRpb25JZFtjb252ZXJzYXRpb25JZF0gPSBzZW5kU3RhdGVSZWR1Y2VyKG9sZFNlbmRTdGF0ZSwge1xuICAgICAgdHlwZSxcbiAgICAgIHVwZGF0ZWRBdDogdW5kZWZpbmVkLFxuICAgIH0pO1xuICB9XG5cbiAgcmV0dXJuIHNlbmRTdGF0ZUJ5Q29udmVyc2F0aW9uSWQ7XG59XG5cbmZ1bmN0aW9uIGdldENvbnZlcnNhdGlvbklkc0Zyb21FcnJvcnMoXG4gIGVycm9yczogdW5kZWZpbmVkIHwgUmVhZG9ubHlBcnJheTxDdXN0b21FcnJvcj4sXG4gIGdldENvbnZlcnNhdGlvbjogR2V0Q29udmVyc2F0aW9uVHlwZVxuKTogQXJyYXk8c3RyaW5nPiB7XG4gIGNvbnN0IHJlc3VsdDogQXJyYXk8c3RyaW5nPiA9IFtdO1xuICAoZXJyb3JzIHx8IFtdKS5mb3JFYWNoKGVycm9yID0+IHtcbiAgICBjb25zdCBjb252ZXJzYXRpb24gPVxuICAgICAgZ2V0Q29udmVyc2F0aW9uKGVycm9yLmlkZW50aWZpZXIpIHx8IGdldENvbnZlcnNhdGlvbihlcnJvci5udW1iZXIpO1xuICAgIGlmIChjb252ZXJzYXRpb24pIHtcbiAgICAgIHJlc3VsdC5wdXNoKGNvbnZlcnNhdGlvbi5pZCk7XG4gICAgfVxuICB9KTtcbiAgcmV0dXJuIHJlc3VsdDtcbn1cblxuZnVuY3Rpb24gZ2V0Q29udmVyc2F0aW9uSWRzRnJvbUxlZ2FjeUF0dHJpYnV0ZShcbiAgbWVzc2FnZTogUmVjb3JkPHN0cmluZywgdW5rbm93bj4sXG4gIGF0dHJpYnV0ZU5hbWU6IHN0cmluZyxcbiAgZ2V0Q29udmVyc2F0aW9uOiBHZXRDb252ZXJzYXRpb25UeXBlXG4pOiBBcnJheTxzdHJpbmc+IHtcbiAgY29uc3QgcmF3VmFsdWU6IHVua25vd24gPVxuICAgIG1lc3NhZ2VbYXR0cmlidXRlTmFtZSBhcyBrZXlvZiBNZXNzYWdlQXR0cmlidXRlc1R5cGVdO1xuICBjb25zdCB2YWx1ZTogQXJyYXk8dW5rbm93bj4gPSBBcnJheS5pc0FycmF5KHJhd1ZhbHVlKSA/IHJhd1ZhbHVlIDogW107XG5cbiAgY29uc3QgcmVzdWx0OiBBcnJheTxzdHJpbmc+ID0gW107XG4gIHZhbHVlLmZvckVhY2goaWRlbnRpZmllciA9PiB7XG4gICAgaWYgKHR5cGVvZiBpZGVudGlmaWVyICE9PSAnc3RyaW5nJykge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBjb25zdCBjb252ZXJzYXRpb24gPSBnZXRDb252ZXJzYXRpb24oaWRlbnRpZmllcik7XG4gICAgaWYgKGNvbnZlcnNhdGlvbikge1xuICAgICAgcmVzdWx0LnB1c2goY29udmVyc2F0aW9uLmlkKTtcbiAgICB9XG4gIH0pO1xuICByZXR1cm4gcmVzdWx0O1xufVxuXG50eXBlIEdldENvbnZlcnNhdGlvblR5cGUgPSAoaWQ/OiBzdHJpbmcgfCBudWxsKSA9PiB7IGlkOiBzdHJpbmcgfSB8IHVuZGVmaW5lZDtcbiJdLAogICJtYXBwaW5ncyI6ICI7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUFBO0FBQUE7QUFBQTtBQUFBO0FBQUE7QUFHQSxvQkFBNkI7QUFDN0Isb0JBQXVCO0FBQ3ZCLHVCQUErQztBQUMvQyxxQkFBMkI7QUFHM0IsOEJBSU87QUFpQkEscUNBQ0wsU0FNQSxpQkFDQSxtQkFDdUM7QUFDdkMsUUFBTSxnQkFDSiwyQkFBUSxRQUFRLHlCQUF5QixLQUFLLCtCQUFXLE9BQU87QUFDbEUsTUFBSSxDQUFDLGVBQWU7QUFDbEIsV0FBTztBQUFBLEVBQ1Q7QUFFQSxRQUFNLG1CQUE4QjtBQUFBLElBQ2xDLFFBQVEsbUNBQVc7QUFBQSxJQUNuQixXQUFXLFFBQVE7QUFBQSxFQUNyQjtBQUVBLFFBQU0sNEJBQXVELGdDQUMzRCxzQ0FDRSxTQUNBLGNBQ0EsZUFDRixHQUNBLDZCQUFPLGdCQUFnQixDQUN6QjtBQUdBLFFBQU0sZ0JBQWdCLFFBQVEsdUJBQUksU0FBUyxNQUFNLENBQUM7QUFFbEQsUUFBTSxVQUFVLDZCQVFkLDBCQUNFLDZCQUE2QixRQUFRLFFBQVEsZUFBZSxHQUM1RCxvQkFBbUI7QUFBQSxJQUNqQixNQUFNLHVDQUFlO0FBQUEsSUFDckI7QUFBQSxFQUNGLEVBQ0YsR0FDQSwwQkFDRSxzQ0FDRSxTQUNBLFdBQ0EsZUFDRixHQUNBLG9CQUFtQjtBQUFBLElBQ2pCLE1BQU0sdUNBQWU7QUFBQSxJQUNyQjtBQUFBLEVBQ0YsRUFDRixHQUNBLDBCQUNFLHNDQUNFLFNBQ0EsZ0JBQ0EsZUFDRixHQUNBLG9CQUFtQjtBQUFBLElBQ2pCLE1BQU0sdUNBQWU7QUFBQSxJQUNyQjtBQUFBLEVBQ0YsRUFDRixHQUNBLDBCQUNFLHNDQUNFLFNBQ0EsV0FDQSxlQUNGLEdBQ0Esb0JBQW1CO0FBQUEsSUFDakIsTUFBTSx1Q0FBZTtBQUFBLElBQ3JCO0FBQUEsRUFDRixFQUNGLEdBQ0E7QUFBQSxJQUNFO0FBQUEsTUFDRSxNQUFNLGdCQUFnQix1Q0FBZSxPQUFPLHVDQUFlO0FBQUEsTUFDM0QsZ0JBQWdCO0FBQUEsSUFDbEI7QUFBQSxFQUNGLENBQ0Y7QUFFQSxhQUFXLEVBQUUsZ0JBQWdCLFVBQVUsU0FBUztBQUM5QyxVQUFNLGVBQ0osMEJBQU8sMkJBQTJCLGNBQWMsS0FBSztBQUN2RCw4QkFBMEIsa0JBQWtCLDhDQUFpQixjQUFjO0FBQUEsTUFDekU7QUFBQSxNQUNBLFdBQVc7QUFBQSxJQUNiLENBQUM7QUFBQSxFQUNIO0FBRUEsU0FBTztBQUNUO0FBbkdnQixBQXFHaEIsc0NBQ0UsUUFDQSxpQkFDZTtBQUNmLFFBQU0sU0FBd0IsQ0FBQztBQUMvQixFQUFDLFdBQVUsQ0FBQyxHQUFHLFFBQVEsV0FBUztBQUM5QixVQUFNLGVBQ0osZ0JBQWdCLE1BQU0sVUFBVSxLQUFLLGdCQUFnQixNQUFNLE1BQU07QUFDbkUsUUFBSSxjQUFjO0FBQ2hCLGFBQU8sS0FBSyxhQUFhLEVBQUU7QUFBQSxJQUM3QjtBQUFBLEVBQ0YsQ0FBQztBQUNELFNBQU87QUFDVDtBQWJTLEFBZVQsK0NBQ0UsU0FDQSxlQUNBLGlCQUNlO0FBQ2YsUUFBTSxXQUNKLFFBQVE7QUFDVixRQUFNLFFBQXdCLE1BQU0sUUFBUSxRQUFRLElBQUksV0FBVyxDQUFDO0FBRXBFLFFBQU0sU0FBd0IsQ0FBQztBQUMvQixRQUFNLFFBQVEsZ0JBQWM7QUFDMUIsUUFBSSxPQUFPLGVBQWUsVUFBVTtBQUNsQztBQUFBLElBQ0Y7QUFDQSxVQUFNLGVBQWUsZ0JBQWdCLFVBQVU7QUFDL0MsUUFBSSxjQUFjO0FBQ2hCLGFBQU8sS0FBSyxhQUFhLEVBQUU7QUFBQSxJQUM3QjtBQUFBLEVBQ0YsQ0FBQztBQUNELFNBQU87QUFDVDtBQXBCUyIsCiAgIm5hbWVzIjogW10KfQo=
