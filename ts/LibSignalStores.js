var __defProp = Object.defineProperty;
var __getOwnPropDesc = Object.getOwnPropertyDescriptor;
var __getOwnPropNames = Object.getOwnPropertyNames;
var __hasOwnProp = Object.prototype.hasOwnProperty;
var __name = (target, value) => __defProp(target, "name", { value, configurable: true });
var __export = (target, all) => {
  for (var name in all)
    __defProp(target, name, { get: all[name], enumerable: true });
};
var __copyProps = (to, from, except, desc) => {
  if (from && typeof from === "object" || typeof from === "function") {
    for (let key of __getOwnPropNames(from))
      if (!__hasOwnProp.call(to, key) && key !== except)
        __defProp(to, key, { get: () => from[key], enumerable: !(desc = __getOwnPropDesc(from, key)) || desc.enumerable });
  }
  return to;
};
var __toCommonJS = (mod) => __copyProps(__defProp({}, "__esModule", { value: true }), mod);
var LibSignalStores_exports = {};
__export(LibSignalStores_exports, {
  IdentityKeys: () => IdentityKeys,
  PreKeys: () => PreKeys,
  SenderKeys: () => SenderKeys,
  Sessions: () => Sessions,
  SignedPreKeys: () => SignedPreKeys
});
module.exports = __toCommonJS(LibSignalStores_exports);
var import_lodash = require("lodash");
var import_libsignal_client = require("@signalapp/libsignal-client");
var import_SignalProtocolStore = require("./SignalProtocolStore");
var import_Address = require("./types/Address");
var import_QualifiedAddress = require("./types/QualifiedAddress");
function encodeAddress(address) {
  const name = address.name();
  const deviceId = address.deviceId();
  return import_Address.Address.create(name, deviceId);
}
function toQualifiedAddress(ourUuid, address) {
  return new import_QualifiedAddress.QualifiedAddress(ourUuid, encodeAddress(address));
}
class Sessions extends import_libsignal_client.SessionStore {
  constructor({ ourUuid, zone }) {
    super();
    this.ourUuid = ourUuid;
    this.zone = zone;
  }
  async saveSession(address, record) {
    await window.textsecure.storage.protocol.storeSession(toQualifiedAddress(this.ourUuid, address), record, { zone: this.zone });
  }
  async getSession(name) {
    const encodedAddress = toQualifiedAddress(this.ourUuid, name);
    const record = await window.textsecure.storage.protocol.loadSession(encodedAddress, { zone: this.zone });
    return record || null;
  }
  async getExistingSessions(addresses) {
    const encodedAddresses = addresses.map((addr) => toQualifiedAddress(this.ourUuid, addr));
    return window.textsecure.storage.protocol.loadSessions(encodedAddresses, {
      zone: this.zone
    });
  }
}
class IdentityKeys extends import_libsignal_client.IdentityKeyStore {
  constructor({ ourUuid, zone }) {
    super();
    this.ourUuid = ourUuid;
    this.zone = zone;
  }
  async getIdentityKey() {
    const keyPair = await window.textsecure.storage.protocol.getIdentityKeyPair(this.ourUuid);
    if (!keyPair) {
      throw new Error("IdentityKeyStore/getIdentityKey: No identity key!");
    }
    return import_libsignal_client.PrivateKey.deserialize(Buffer.from(keyPair.privKey));
  }
  async getLocalRegistrationId() {
    const id = await window.textsecure.storage.protocol.getLocalRegistrationId(this.ourUuid);
    if (!(0, import_lodash.isNumber)(id)) {
      throw new Error("IdentityKeyStore/getLocalRegistrationId: No registration id!");
    }
    return id;
  }
  async getIdentity(address) {
    const encodedAddress = encodeAddress(address);
    const key = await window.textsecure.storage.protocol.loadIdentityKey(encodedAddress.uuid);
    if (!key) {
      return null;
    }
    return import_libsignal_client.PublicKey.deserialize(Buffer.from(key));
  }
  async saveIdentity(name, key) {
    const encodedAddress = encodeAddress(name);
    const publicKey = key.serialize();
    return window.textsecure.storage.protocol.saveIdentity(encodedAddress, publicKey, false, { zone: this.zone });
  }
  async isTrustedIdentity(name, key, direction) {
    const encodedAddress = encodeAddress(name);
    const publicKey = key.serialize();
    return window.textsecure.storage.protocol.isTrustedIdentity(encodedAddress, publicKey, direction);
  }
}
class PreKeys extends import_libsignal_client.PreKeyStore {
  constructor({ ourUuid }) {
    super();
    this.ourUuid = ourUuid;
  }
  async savePreKey(id, record) {
    await window.textsecure.storage.protocol.storePreKey(this.ourUuid, id, (0, import_SignalProtocolStore.freezePreKey)(record));
  }
  async getPreKey(id) {
    const preKey = await window.textsecure.storage.protocol.loadPreKey(this.ourUuid, id);
    if (preKey === void 0) {
      throw new Error(`getPreKey: PreKey ${id} not found`);
    }
    return preKey;
  }
  async removePreKey(id) {
    await window.textsecure.storage.protocol.removePreKey(this.ourUuid, id);
  }
}
class SenderKeys extends import_libsignal_client.SenderKeyStore {
  constructor({ ourUuid, zone }) {
    super();
    this.ourUuid = ourUuid;
    this.zone = zone;
  }
  async saveSenderKey(sender, distributionId, record) {
    const encodedAddress = toQualifiedAddress(this.ourUuid, sender);
    await window.textsecure.storage.protocol.saveSenderKey(encodedAddress, distributionId, record, { zone: this.zone });
  }
  async getSenderKey(sender, distributionId) {
    const encodedAddress = toQualifiedAddress(this.ourUuid, sender);
    const senderKey = await window.textsecure.storage.protocol.getSenderKey(encodedAddress, distributionId, { zone: this.zone });
    return senderKey || null;
  }
}
class SignedPreKeys extends import_libsignal_client.SignedPreKeyStore {
  constructor({ ourUuid }) {
    super();
    this.ourUuid = ourUuid;
  }
  async saveSignedPreKey(id, record) {
    await window.textsecure.storage.protocol.storeSignedPreKey(this.ourUuid, id, (0, import_SignalProtocolStore.freezeSignedPreKey)(record), true);
  }
  async getSignedPreKey(id) {
    const signedPreKey = await window.textsecure.storage.protocol.loadSignedPreKey(this.ourUuid, id);
    if (!signedPreKey) {
      throw new Error(`getSignedPreKey: SignedPreKey ${id} not found`);
    }
    return signedPreKey;
  }
}
// Annotate the CommonJS export names for ESM import in node:
0 && (module.exports = {
  IdentityKeys,
  PreKeys,
  SenderKeys,
  Sessions,
  SignedPreKeys
});
//# sourceMappingURL=data:application/json;base64,ewogICJ2ZXJzaW9uIjogMywKICAic291cmNlcyI6IFsiTGliU2lnbmFsU3RvcmVzLnRzIl0sCiAgInNvdXJjZXNDb250ZW50IjogWyIvLyBDb3B5cmlnaHQgMjAyMSBTaWduYWwgTWVzc2VuZ2VyLCBMTENcbi8vIFNQRFgtTGljZW5zZS1JZGVudGlmaWVyOiBBR1BMLTMuMC1vbmx5XG5cbi8qIGVzbGludC1kaXNhYmxlIG1heC1jbGFzc2VzLXBlci1maWxlICovXG5cbmltcG9ydCB7IGlzTnVtYmVyIH0gZnJvbSAnbG9kYXNoJztcblxuaW1wb3J0IHR5cGUge1xuICBEaXJlY3Rpb24sXG4gIFByZUtleVJlY29yZCxcbiAgUHJvdG9jb2xBZGRyZXNzLFxuICBTZW5kZXJLZXlSZWNvcmQsXG4gIFNlc3Npb25SZWNvcmQsXG4gIFNpZ25lZFByZUtleVJlY29yZCxcbiAgVXVpZCxcbn0gZnJvbSAnQHNpZ25hbGFwcC9saWJzaWduYWwtY2xpZW50JztcbmltcG9ydCB7XG4gIElkZW50aXR5S2V5U3RvcmUsXG4gIFByZUtleVN0b3JlLFxuICBQcml2YXRlS2V5LFxuICBQdWJsaWNLZXksXG4gIFNlbmRlcktleVN0b3JlLFxuICBTZXNzaW9uU3RvcmUsXG4gIFNpZ25lZFByZUtleVN0b3JlLFxufSBmcm9tICdAc2lnbmFsYXBwL2xpYnNpZ25hbC1jbGllbnQnO1xuaW1wb3J0IHsgZnJlZXplUHJlS2V5LCBmcmVlemVTaWduZWRQcmVLZXkgfSBmcm9tICcuL1NpZ25hbFByb3RvY29sU3RvcmUnO1xuaW1wb3J0IHsgQWRkcmVzcyB9IGZyb20gJy4vdHlwZXMvQWRkcmVzcyc7XG5pbXBvcnQgeyBRdWFsaWZpZWRBZGRyZXNzIH0gZnJvbSAnLi90eXBlcy9RdWFsaWZpZWRBZGRyZXNzJztcbmltcG9ydCB0eXBlIHsgVVVJRCB9IGZyb20gJy4vdHlwZXMvVVVJRCc7XG5cbmltcG9ydCB0eXBlIHsgWm9uZSB9IGZyb20gJy4vdXRpbC9ab25lJztcblxuZnVuY3Rpb24gZW5jb2RlQWRkcmVzcyhhZGRyZXNzOiBQcm90b2NvbEFkZHJlc3MpOiBBZGRyZXNzIHtcbiAgY29uc3QgbmFtZSA9IGFkZHJlc3MubmFtZSgpO1xuICBjb25zdCBkZXZpY2VJZCA9IGFkZHJlc3MuZGV2aWNlSWQoKTtcbiAgcmV0dXJuIEFkZHJlc3MuY3JlYXRlKG5hbWUsIGRldmljZUlkKTtcbn1cblxuZnVuY3Rpb24gdG9RdWFsaWZpZWRBZGRyZXNzKFxuICBvdXJVdWlkOiBVVUlELFxuICBhZGRyZXNzOiBQcm90b2NvbEFkZHJlc3Ncbik6IFF1YWxpZmllZEFkZHJlc3Mge1xuICByZXR1cm4gbmV3IFF1YWxpZmllZEFkZHJlc3Mob3VyVXVpZCwgZW5jb2RlQWRkcmVzcyhhZGRyZXNzKSk7XG59XG5cbmV4cG9ydCB0eXBlIFNlc3Npb25zT3B0aW9ucyA9IFJlYWRvbmx5PHtcbiAgb3VyVXVpZDogVVVJRDtcbiAgem9uZT86IFpvbmU7XG59PjtcblxuZXhwb3J0IGNsYXNzIFNlc3Npb25zIGV4dGVuZHMgU2Vzc2lvblN0b3JlIHtcbiAgcHJpdmF0ZSByZWFkb25seSBvdXJVdWlkOiBVVUlEO1xuXG4gIHByaXZhdGUgcmVhZG9ubHkgem9uZTogWm9uZSB8IHVuZGVmaW5lZDtcblxuICBjb25zdHJ1Y3Rvcih7IG91clV1aWQsIHpvbmUgfTogU2Vzc2lvbnNPcHRpb25zKSB7XG4gICAgc3VwZXIoKTtcblxuICAgIHRoaXMub3VyVXVpZCA9IG91clV1aWQ7XG4gICAgdGhpcy56b25lID0gem9uZTtcbiAgfVxuXG4gIGFzeW5jIHNhdmVTZXNzaW9uKFxuICAgIGFkZHJlc3M6IFByb3RvY29sQWRkcmVzcyxcbiAgICByZWNvcmQ6IFNlc3Npb25SZWNvcmRcbiAgKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgYXdhaXQgd2luZG93LnRleHRzZWN1cmUuc3RvcmFnZS5wcm90b2NvbC5zdG9yZVNlc3Npb24oXG4gICAgICB0b1F1YWxpZmllZEFkZHJlc3ModGhpcy5vdXJVdWlkLCBhZGRyZXNzKSxcbiAgICAgIHJlY29yZCxcbiAgICAgIHsgem9uZTogdGhpcy56b25lIH1cbiAgICApO1xuICB9XG5cbiAgYXN5bmMgZ2V0U2Vzc2lvbihuYW1lOiBQcm90b2NvbEFkZHJlc3MpOiBQcm9taXNlPFNlc3Npb25SZWNvcmQgfCBudWxsPiB7XG4gICAgY29uc3QgZW5jb2RlZEFkZHJlc3MgPSB0b1F1YWxpZmllZEFkZHJlc3ModGhpcy5vdXJVdWlkLCBuYW1lKTtcbiAgICBjb25zdCByZWNvcmQgPSBhd2FpdCB3aW5kb3cudGV4dHNlY3VyZS5zdG9yYWdlLnByb3RvY29sLmxvYWRTZXNzaW9uKFxuICAgICAgZW5jb2RlZEFkZHJlc3MsXG4gICAgICB7IHpvbmU6IHRoaXMuem9uZSB9XG4gICAgKTtcblxuICAgIHJldHVybiByZWNvcmQgfHwgbnVsbDtcbiAgfVxuXG4gIGFzeW5jIGdldEV4aXN0aW5nU2Vzc2lvbnMoXG4gICAgYWRkcmVzc2VzOiBBcnJheTxQcm90b2NvbEFkZHJlc3M+XG4gICk6IFByb21pc2U8QXJyYXk8U2Vzc2lvblJlY29yZD4+IHtcbiAgICBjb25zdCBlbmNvZGVkQWRkcmVzc2VzID0gYWRkcmVzc2VzLm1hcChhZGRyID0+XG4gICAgICB0b1F1YWxpZmllZEFkZHJlc3ModGhpcy5vdXJVdWlkLCBhZGRyKVxuICAgICk7XG4gICAgcmV0dXJuIHdpbmRvdy50ZXh0c2VjdXJlLnN0b3JhZ2UucHJvdG9jb2wubG9hZFNlc3Npb25zKGVuY29kZWRBZGRyZXNzZXMsIHtcbiAgICAgIHpvbmU6IHRoaXMuem9uZSxcbiAgICB9KTtcbiAgfVxufVxuXG5leHBvcnQgdHlwZSBJZGVudGl0eUtleXNPcHRpb25zID0gUmVhZG9ubHk8e1xuICBvdXJVdWlkOiBVVUlEO1xuICB6b25lPzogWm9uZTtcbn0+O1xuXG5leHBvcnQgY2xhc3MgSWRlbnRpdHlLZXlzIGV4dGVuZHMgSWRlbnRpdHlLZXlTdG9yZSB7XG4gIHByaXZhdGUgcmVhZG9ubHkgb3VyVXVpZDogVVVJRDtcblxuICBwcml2YXRlIHJlYWRvbmx5IHpvbmU6IFpvbmUgfCB1bmRlZmluZWQ7XG5cbiAgY29uc3RydWN0b3IoeyBvdXJVdWlkLCB6b25lIH06IElkZW50aXR5S2V5c09wdGlvbnMpIHtcbiAgICBzdXBlcigpO1xuXG4gICAgdGhpcy5vdXJVdWlkID0gb3VyVXVpZDtcbiAgICB0aGlzLnpvbmUgPSB6b25lO1xuICB9XG5cbiAgYXN5bmMgZ2V0SWRlbnRpdHlLZXkoKTogUHJvbWlzZTxQcml2YXRlS2V5PiB7XG4gICAgY29uc3Qga2V5UGFpciA9IGF3YWl0IHdpbmRvdy50ZXh0c2VjdXJlLnN0b3JhZ2UucHJvdG9jb2wuZ2V0SWRlbnRpdHlLZXlQYWlyKFxuICAgICAgdGhpcy5vdXJVdWlkXG4gICAgKTtcbiAgICBpZiAoIWtleVBhaXIpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignSWRlbnRpdHlLZXlTdG9yZS9nZXRJZGVudGl0eUtleTogTm8gaWRlbnRpdHkga2V5IScpO1xuICAgIH1cbiAgICByZXR1cm4gUHJpdmF0ZUtleS5kZXNlcmlhbGl6ZShCdWZmZXIuZnJvbShrZXlQYWlyLnByaXZLZXkpKTtcbiAgfVxuXG4gIGFzeW5jIGdldExvY2FsUmVnaXN0cmF0aW9uSWQoKTogUHJvbWlzZTxudW1iZXI+IHtcbiAgICBjb25zdCBpZCA9IGF3YWl0IHdpbmRvdy50ZXh0c2VjdXJlLnN0b3JhZ2UucHJvdG9jb2wuZ2V0TG9jYWxSZWdpc3RyYXRpb25JZChcbiAgICAgIHRoaXMub3VyVXVpZFxuICAgICk7XG4gICAgaWYgKCFpc051bWJlcihpZCkpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgJ0lkZW50aXR5S2V5U3RvcmUvZ2V0TG9jYWxSZWdpc3RyYXRpb25JZDogTm8gcmVnaXN0cmF0aW9uIGlkISdcbiAgICAgICk7XG4gICAgfVxuICAgIHJldHVybiBpZDtcbiAgfVxuXG4gIGFzeW5jIGdldElkZW50aXR5KGFkZHJlc3M6IFByb3RvY29sQWRkcmVzcyk6IFByb21pc2U8UHVibGljS2V5IHwgbnVsbD4ge1xuICAgIGNvbnN0IGVuY29kZWRBZGRyZXNzID0gZW5jb2RlQWRkcmVzcyhhZGRyZXNzKTtcbiAgICBjb25zdCBrZXkgPSBhd2FpdCB3aW5kb3cudGV4dHNlY3VyZS5zdG9yYWdlLnByb3RvY29sLmxvYWRJZGVudGl0eUtleShcbiAgICAgIGVuY29kZWRBZGRyZXNzLnV1aWRcbiAgICApO1xuXG4gICAgaWYgKCFrZXkpIHtcbiAgICAgIHJldHVybiBudWxsO1xuICAgIH1cblxuICAgIHJldHVybiBQdWJsaWNLZXkuZGVzZXJpYWxpemUoQnVmZmVyLmZyb20oa2V5KSk7XG4gIH1cblxuICBhc3luYyBzYXZlSWRlbnRpdHkobmFtZTogUHJvdG9jb2xBZGRyZXNzLCBrZXk6IFB1YmxpY0tleSk6IFByb21pc2U8Ym9vbGVhbj4ge1xuICAgIGNvbnN0IGVuY29kZWRBZGRyZXNzID0gZW5jb2RlQWRkcmVzcyhuYW1lKTtcbiAgICBjb25zdCBwdWJsaWNLZXkgPSBrZXkuc2VyaWFsaXplKCk7XG5cbiAgICAvLyBQYXNzIGB6b25lYCB0byBsZXQgYHNhdmVJZGVudGl0eWAgYXJjaGl2ZSBzaWJsaW5nIHNlc3Npb25zIHdoZW4gaWRlbnRpdHlcbiAgICAvLyBrZXkgY2hhbmdlcy5cbiAgICByZXR1cm4gd2luZG93LnRleHRzZWN1cmUuc3RvcmFnZS5wcm90b2NvbC5zYXZlSWRlbnRpdHkoXG4gICAgICBlbmNvZGVkQWRkcmVzcyxcbiAgICAgIHB1YmxpY0tleSxcbiAgICAgIGZhbHNlLFxuICAgICAgeyB6b25lOiB0aGlzLnpvbmUgfVxuICAgICk7XG4gIH1cblxuICBhc3luYyBpc1RydXN0ZWRJZGVudGl0eShcbiAgICBuYW1lOiBQcm90b2NvbEFkZHJlc3MsXG4gICAga2V5OiBQdWJsaWNLZXksXG4gICAgZGlyZWN0aW9uOiBEaXJlY3Rpb25cbiAgKTogUHJvbWlzZTxib29sZWFuPiB7XG4gICAgY29uc3QgZW5jb2RlZEFkZHJlc3MgPSBlbmNvZGVBZGRyZXNzKG5hbWUpO1xuICAgIGNvbnN0IHB1YmxpY0tleSA9IGtleS5zZXJpYWxpemUoKTtcblxuICAgIHJldHVybiB3aW5kb3cudGV4dHNlY3VyZS5zdG9yYWdlLnByb3RvY29sLmlzVHJ1c3RlZElkZW50aXR5KFxuICAgICAgZW5jb2RlZEFkZHJlc3MsXG4gICAgICBwdWJsaWNLZXksXG4gICAgICBkaXJlY3Rpb25cbiAgICApO1xuICB9XG59XG5cbmV4cG9ydCB0eXBlIFByZUtleXNPcHRpb25zID0gUmVhZG9ubHk8e1xuICBvdXJVdWlkOiBVVUlEO1xufT47XG5cbmV4cG9ydCBjbGFzcyBQcmVLZXlzIGV4dGVuZHMgUHJlS2V5U3RvcmUge1xuICBwcml2YXRlIHJlYWRvbmx5IG91clV1aWQ6IFVVSUQ7XG5cbiAgY29uc3RydWN0b3IoeyBvdXJVdWlkIH06IFByZUtleXNPcHRpb25zKSB7XG4gICAgc3VwZXIoKTtcbiAgICB0aGlzLm91clV1aWQgPSBvdXJVdWlkO1xuICB9XG5cbiAgYXN5bmMgc2F2ZVByZUtleShpZDogbnVtYmVyLCByZWNvcmQ6IFByZUtleVJlY29yZCk6IFByb21pc2U8dm9pZD4ge1xuICAgIGF3YWl0IHdpbmRvdy50ZXh0c2VjdXJlLnN0b3JhZ2UucHJvdG9jb2wuc3RvcmVQcmVLZXkoXG4gICAgICB0aGlzLm91clV1aWQsXG4gICAgICBpZCxcbiAgICAgIGZyZWV6ZVByZUtleShyZWNvcmQpXG4gICAgKTtcbiAgfVxuXG4gIGFzeW5jIGdldFByZUtleShpZDogbnVtYmVyKTogUHJvbWlzZTxQcmVLZXlSZWNvcmQ+IHtcbiAgICBjb25zdCBwcmVLZXkgPSBhd2FpdCB3aW5kb3cudGV4dHNlY3VyZS5zdG9yYWdlLnByb3RvY29sLmxvYWRQcmVLZXkoXG4gICAgICB0aGlzLm91clV1aWQsXG4gICAgICBpZFxuICAgICk7XG5cbiAgICBpZiAocHJlS2V5ID09PSB1bmRlZmluZWQpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgZ2V0UHJlS2V5OiBQcmVLZXkgJHtpZH0gbm90IGZvdW5kYCk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHByZUtleTtcbiAgfVxuXG4gIGFzeW5jIHJlbW92ZVByZUtleShpZDogbnVtYmVyKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgYXdhaXQgd2luZG93LnRleHRzZWN1cmUuc3RvcmFnZS5wcm90b2NvbC5yZW1vdmVQcmVLZXkodGhpcy5vdXJVdWlkLCBpZCk7XG4gIH1cbn1cblxuZXhwb3J0IHR5cGUgU2VuZGVyS2V5c09wdGlvbnMgPSBSZWFkb25seTx7XG4gIHJlYWRvbmx5IG91clV1aWQ6IFVVSUQ7XG4gIHJlYWRvbmx5IHpvbmU6IFpvbmUgfCB1bmRlZmluZWQ7XG59PjtcblxuZXhwb3J0IGNsYXNzIFNlbmRlcktleXMgZXh0ZW5kcyBTZW5kZXJLZXlTdG9yZSB7XG4gIHByaXZhdGUgcmVhZG9ubHkgb3VyVXVpZDogVVVJRDtcblxuICByZWFkb25seSB6b25lOiBab25lIHwgdW5kZWZpbmVkO1xuXG4gIGNvbnN0cnVjdG9yKHsgb3VyVXVpZCwgem9uZSB9OiBTZW5kZXJLZXlzT3B0aW9ucykge1xuICAgIHN1cGVyKCk7XG4gICAgdGhpcy5vdXJVdWlkID0gb3VyVXVpZDtcbiAgICB0aGlzLnpvbmUgPSB6b25lO1xuICB9XG5cbiAgYXN5bmMgc2F2ZVNlbmRlcktleShcbiAgICBzZW5kZXI6IFByb3RvY29sQWRkcmVzcyxcbiAgICBkaXN0cmlidXRpb25JZDogVXVpZCxcbiAgICByZWNvcmQ6IFNlbmRlcktleVJlY29yZFxuICApOiBQcm9taXNlPHZvaWQ+IHtcbiAgICBjb25zdCBlbmNvZGVkQWRkcmVzcyA9IHRvUXVhbGlmaWVkQWRkcmVzcyh0aGlzLm91clV1aWQsIHNlbmRlcik7XG5cbiAgICBhd2FpdCB3aW5kb3cudGV4dHNlY3VyZS5zdG9yYWdlLnByb3RvY29sLnNhdmVTZW5kZXJLZXkoXG4gICAgICBlbmNvZGVkQWRkcmVzcyxcbiAgICAgIGRpc3RyaWJ1dGlvbklkLFxuICAgICAgcmVjb3JkLFxuICAgICAgeyB6b25lOiB0aGlzLnpvbmUgfVxuICAgICk7XG4gIH1cblxuICBhc3luYyBnZXRTZW5kZXJLZXkoXG4gICAgc2VuZGVyOiBQcm90b2NvbEFkZHJlc3MsXG4gICAgZGlzdHJpYnV0aW9uSWQ6IFV1aWRcbiAgKTogUHJvbWlzZTxTZW5kZXJLZXlSZWNvcmQgfCBudWxsPiB7XG4gICAgY29uc3QgZW5jb2RlZEFkZHJlc3MgPSB0b1F1YWxpZmllZEFkZHJlc3ModGhpcy5vdXJVdWlkLCBzZW5kZXIpO1xuXG4gICAgY29uc3Qgc2VuZGVyS2V5ID0gYXdhaXQgd2luZG93LnRleHRzZWN1cmUuc3RvcmFnZS5wcm90b2NvbC5nZXRTZW5kZXJLZXkoXG4gICAgICBlbmNvZGVkQWRkcmVzcyxcbiAgICAgIGRpc3RyaWJ1dGlvbklkLFxuICAgICAgeyB6b25lOiB0aGlzLnpvbmUgfVxuICAgICk7XG5cbiAgICByZXR1cm4gc2VuZGVyS2V5IHx8IG51bGw7XG4gIH1cbn1cblxuZXhwb3J0IHR5cGUgU2lnbmVkUHJlS2V5c09wdGlvbnMgPSBSZWFkb25seTx7XG4gIG91clV1aWQ6IFVVSUQ7XG59PjtcblxuZXhwb3J0IGNsYXNzIFNpZ25lZFByZUtleXMgZXh0ZW5kcyBTaWduZWRQcmVLZXlTdG9yZSB7XG4gIHByaXZhdGUgcmVhZG9ubHkgb3VyVXVpZDogVVVJRDtcblxuICBjb25zdHJ1Y3Rvcih7IG91clV1aWQgfTogU2lnbmVkUHJlS2V5c09wdGlvbnMpIHtcbiAgICBzdXBlcigpO1xuICAgIHRoaXMub3VyVXVpZCA9IG91clV1aWQ7XG4gIH1cblxuICBhc3luYyBzYXZlU2lnbmVkUHJlS2V5KFxuICAgIGlkOiBudW1iZXIsXG4gICAgcmVjb3JkOiBTaWduZWRQcmVLZXlSZWNvcmRcbiAgKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgYXdhaXQgd2luZG93LnRleHRzZWN1cmUuc3RvcmFnZS5wcm90b2NvbC5zdG9yZVNpZ25lZFByZUtleShcbiAgICAgIHRoaXMub3VyVXVpZCxcbiAgICAgIGlkLFxuICAgICAgZnJlZXplU2lnbmVkUHJlS2V5KHJlY29yZCksXG4gICAgICB0cnVlXG4gICAgKTtcbiAgfVxuXG4gIGFzeW5jIGdldFNpZ25lZFByZUtleShpZDogbnVtYmVyKTogUHJvbWlzZTxTaWduZWRQcmVLZXlSZWNvcmQ+IHtcbiAgICBjb25zdCBzaWduZWRQcmVLZXkgPVxuICAgICAgYXdhaXQgd2luZG93LnRleHRzZWN1cmUuc3RvcmFnZS5wcm90b2NvbC5sb2FkU2lnbmVkUHJlS2V5KFxuICAgICAgICB0aGlzLm91clV1aWQsXG4gICAgICAgIGlkXG4gICAgICApO1xuXG4gICAgaWYgKCFzaWduZWRQcmVLZXkpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgZ2V0U2lnbmVkUHJlS2V5OiBTaWduZWRQcmVLZXkgJHtpZH0gbm90IGZvdW5kYCk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHNpZ25lZFByZUtleTtcbiAgfVxufVxuIl0sCiAgIm1hcHBpbmdzIjogIjs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBQUE7QUFBQTtBQUFBO0FBQUE7QUFBQTtBQUFBO0FBQUE7QUFBQTtBQUFBO0FBS0Esb0JBQXlCO0FBV3pCLDhCQVFPO0FBQ1AsaUNBQWlEO0FBQ2pELHFCQUF3QjtBQUN4Qiw4QkFBaUM7QUFLakMsdUJBQXVCLFNBQW1DO0FBQ3hELFFBQU0sT0FBTyxRQUFRLEtBQUs7QUFDMUIsUUFBTSxXQUFXLFFBQVEsU0FBUztBQUNsQyxTQUFPLHVCQUFRLE9BQU8sTUFBTSxRQUFRO0FBQ3RDO0FBSlMsQUFNVCw0QkFDRSxTQUNBLFNBQ2tCO0FBQ2xCLFNBQU8sSUFBSSx5Q0FBaUIsU0FBUyxjQUFjLE9BQU8sQ0FBQztBQUM3RDtBQUxTLEFBWUYsTUFBTSxpQkFBaUIscUNBQWE7QUFBQSxFQUt6QyxZQUFZLEVBQUUsU0FBUyxRQUF5QjtBQUM5QyxVQUFNO0FBRU4sU0FBSyxVQUFVO0FBQ2YsU0FBSyxPQUFPO0FBQUEsRUFDZDtBQUFBLFFBRU0sWUFDSixTQUNBLFFBQ2U7QUFDZixVQUFNLE9BQU8sV0FBVyxRQUFRLFNBQVMsYUFDdkMsbUJBQW1CLEtBQUssU0FBUyxPQUFPLEdBQ3hDLFFBQ0EsRUFBRSxNQUFNLEtBQUssS0FBSyxDQUNwQjtBQUFBLEVBQ0Y7QUFBQSxRQUVNLFdBQVcsTUFBc0Q7QUFDckUsVUFBTSxpQkFBaUIsbUJBQW1CLEtBQUssU0FBUyxJQUFJO0FBQzVELFVBQU0sU0FBUyxNQUFNLE9BQU8sV0FBVyxRQUFRLFNBQVMsWUFDdEQsZ0JBQ0EsRUFBRSxNQUFNLEtBQUssS0FBSyxDQUNwQjtBQUVBLFdBQU8sVUFBVTtBQUFBLEVBQ25CO0FBQUEsUUFFTSxvQkFDSixXQUMrQjtBQUMvQixVQUFNLG1CQUFtQixVQUFVLElBQUksVUFDckMsbUJBQW1CLEtBQUssU0FBUyxJQUFJLENBQ3ZDO0FBQ0EsV0FBTyxPQUFPLFdBQVcsUUFBUSxTQUFTLGFBQWEsa0JBQWtCO0FBQUEsTUFDdkUsTUFBTSxLQUFLO0FBQUEsSUFDYixDQUFDO0FBQUEsRUFDSDtBQUNGO0FBM0NPLEFBa0RBLE1BQU0scUJBQXFCLHlDQUFpQjtBQUFBLEVBS2pELFlBQVksRUFBRSxTQUFTLFFBQTZCO0FBQ2xELFVBQU07QUFFTixTQUFLLFVBQVU7QUFDZixTQUFLLE9BQU87QUFBQSxFQUNkO0FBQUEsUUFFTSxpQkFBc0M7QUFDMUMsVUFBTSxVQUFVLE1BQU0sT0FBTyxXQUFXLFFBQVEsU0FBUyxtQkFDdkQsS0FBSyxPQUNQO0FBQ0EsUUFBSSxDQUFDLFNBQVM7QUFDWixZQUFNLElBQUksTUFBTSxtREFBbUQ7QUFBQSxJQUNyRTtBQUNBLFdBQU8sbUNBQVcsWUFBWSxPQUFPLEtBQUssUUFBUSxPQUFPLENBQUM7QUFBQSxFQUM1RDtBQUFBLFFBRU0seUJBQTBDO0FBQzlDLFVBQU0sS0FBSyxNQUFNLE9BQU8sV0FBVyxRQUFRLFNBQVMsdUJBQ2xELEtBQUssT0FDUDtBQUNBLFFBQUksQ0FBQyw0QkFBUyxFQUFFLEdBQUc7QUFDakIsWUFBTSxJQUFJLE1BQ1IsOERBQ0Y7QUFBQSxJQUNGO0FBQ0EsV0FBTztBQUFBLEVBQ1Q7QUFBQSxRQUVNLFlBQVksU0FBcUQ7QUFDckUsVUFBTSxpQkFBaUIsY0FBYyxPQUFPO0FBQzVDLFVBQU0sTUFBTSxNQUFNLE9BQU8sV0FBVyxRQUFRLFNBQVMsZ0JBQ25ELGVBQWUsSUFDakI7QUFFQSxRQUFJLENBQUMsS0FBSztBQUNSLGFBQU87QUFBQSxJQUNUO0FBRUEsV0FBTyxrQ0FBVSxZQUFZLE9BQU8sS0FBSyxHQUFHLENBQUM7QUFBQSxFQUMvQztBQUFBLFFBRU0sYUFBYSxNQUF1QixLQUFrQztBQUMxRSxVQUFNLGlCQUFpQixjQUFjLElBQUk7QUFDekMsVUFBTSxZQUFZLElBQUksVUFBVTtBQUloQyxXQUFPLE9BQU8sV0FBVyxRQUFRLFNBQVMsYUFDeEMsZ0JBQ0EsV0FDQSxPQUNBLEVBQUUsTUFBTSxLQUFLLEtBQUssQ0FDcEI7QUFBQSxFQUNGO0FBQUEsUUFFTSxrQkFDSixNQUNBLEtBQ0EsV0FDa0I7QUFDbEIsVUFBTSxpQkFBaUIsY0FBYyxJQUFJO0FBQ3pDLFVBQU0sWUFBWSxJQUFJLFVBQVU7QUFFaEMsV0FBTyxPQUFPLFdBQVcsUUFBUSxTQUFTLGtCQUN4QyxnQkFDQSxXQUNBLFNBQ0Y7QUFBQSxFQUNGO0FBQ0Y7QUEzRU8sQUFpRkEsTUFBTSxnQkFBZ0Isb0NBQVk7QUFBQSxFQUd2QyxZQUFZLEVBQUUsV0FBMkI7QUFDdkMsVUFBTTtBQUNOLFNBQUssVUFBVTtBQUFBLEVBQ2pCO0FBQUEsUUFFTSxXQUFXLElBQVksUUFBcUM7QUFDaEUsVUFBTSxPQUFPLFdBQVcsUUFBUSxTQUFTLFlBQ3ZDLEtBQUssU0FDTCxJQUNBLDZDQUFhLE1BQU0sQ0FDckI7QUFBQSxFQUNGO0FBQUEsUUFFTSxVQUFVLElBQW1DO0FBQ2pELFVBQU0sU0FBUyxNQUFNLE9BQU8sV0FBVyxRQUFRLFNBQVMsV0FDdEQsS0FBSyxTQUNMLEVBQ0Y7QUFFQSxRQUFJLFdBQVcsUUFBVztBQUN4QixZQUFNLElBQUksTUFBTSxxQkFBcUIsY0FBYztBQUFBLElBQ3JEO0FBRUEsV0FBTztBQUFBLEVBQ1Q7QUFBQSxRQUVNLGFBQWEsSUFBMkI7QUFDNUMsVUFBTSxPQUFPLFdBQVcsUUFBUSxTQUFTLGFBQWEsS0FBSyxTQUFTLEVBQUU7QUFBQSxFQUN4RTtBQUNGO0FBaENPLEFBdUNBLE1BQU0sbUJBQW1CLHVDQUFlO0FBQUEsRUFLN0MsWUFBWSxFQUFFLFNBQVMsUUFBMkI7QUFDaEQsVUFBTTtBQUNOLFNBQUssVUFBVTtBQUNmLFNBQUssT0FBTztBQUFBLEVBQ2Q7QUFBQSxRQUVNLGNBQ0osUUFDQSxnQkFDQSxRQUNlO0FBQ2YsVUFBTSxpQkFBaUIsbUJBQW1CLEtBQUssU0FBUyxNQUFNO0FBRTlELFVBQU0sT0FBTyxXQUFXLFFBQVEsU0FBUyxjQUN2QyxnQkFDQSxnQkFDQSxRQUNBLEVBQUUsTUFBTSxLQUFLLEtBQUssQ0FDcEI7QUFBQSxFQUNGO0FBQUEsUUFFTSxhQUNKLFFBQ0EsZ0JBQ2lDO0FBQ2pDLFVBQU0saUJBQWlCLG1CQUFtQixLQUFLLFNBQVMsTUFBTTtBQUU5RCxVQUFNLFlBQVksTUFBTSxPQUFPLFdBQVcsUUFBUSxTQUFTLGFBQ3pELGdCQUNBLGdCQUNBLEVBQUUsTUFBTSxLQUFLLEtBQUssQ0FDcEI7QUFFQSxXQUFPLGFBQWE7QUFBQSxFQUN0QjtBQUNGO0FBeENPLEFBOENBLE1BQU0sc0JBQXNCLDBDQUFrQjtBQUFBLEVBR25ELFlBQVksRUFBRSxXQUFpQztBQUM3QyxVQUFNO0FBQ04sU0FBSyxVQUFVO0FBQUEsRUFDakI7QUFBQSxRQUVNLGlCQUNKLElBQ0EsUUFDZTtBQUNmLFVBQU0sT0FBTyxXQUFXLFFBQVEsU0FBUyxrQkFDdkMsS0FBSyxTQUNMLElBQ0EsbURBQW1CLE1BQU0sR0FDekIsSUFDRjtBQUFBLEVBQ0Y7QUFBQSxRQUVNLGdCQUFnQixJQUF5QztBQUM3RCxVQUFNLGVBQ0osTUFBTSxPQUFPLFdBQVcsUUFBUSxTQUFTLGlCQUN2QyxLQUFLLFNBQ0wsRUFDRjtBQUVGLFFBQUksQ0FBQyxjQUFjO0FBQ2pCLFlBQU0sSUFBSSxNQUFNLGlDQUFpQyxjQUFjO0FBQUEsSUFDakU7QUFFQSxXQUFPO0FBQUEsRUFDVDtBQUNGO0FBakNPIiwKICAibmFtZXMiOiBbXQp9Cg==
