var __create = Object.create;
var __defProp = Object.defineProperty;
var __getOwnPropDesc = Object.getOwnPropertyDescriptor;
var __getOwnPropNames = Object.getOwnPropertyNames;
var __getProtoOf = Object.getPrototypeOf;
var __hasOwnProp = Object.prototype.hasOwnProperty;
var __name = (target, value) => __defProp(target, "name", { value, configurable: true });
var __export = (target, all) => {
  for (var name in all)
    __defProp(target, name, { get: all[name], enumerable: true });
};
var __copyProps = (to, from, except, desc) => {
  if (from && typeof from === "object" || typeof from === "function") {
    for (let key of __getOwnPropNames(from))
      if (!__hasOwnProp.call(to, key) && key !== except)
        __defProp(to, key, { get: () => from[key], enumerable: !(desc = __getOwnPropDesc(from, key)) || desc.enumerable });
  }
  return to;
};
var __toESM = (mod, isNodeMode, target) => (target = mod != null ? __create(__getProtoOf(mod)) : {}, __copyProps(isNodeMode || !mod || !mod.__esModule ? __defProp(target, "default", { value: mod, enumerable: true }) : target, mod));
var __toCommonJS = (mod) => __copyProps(__defProp({}, "__esModule", { value: true }), mod);
var useFabricHistory_exports = {};
__export(useFabricHistory_exports, {
  useFabricHistory: () => useFabricHistory
});
module.exports = __toCommonJS(useFabricHistory_exports);
var import_react = require("react");
var import_fabric = require("fabric");
var log = __toESM(require("../logging/log"));
var import_MediaEditorFabricIText = require("./MediaEditorFabricIText");
var import_MediaEditorFabricPath = require("./MediaEditorFabricPath");
var import_MediaEditorFabricSticker = require("./MediaEditorFabricSticker");
var import_fabricEffectListener = require("./fabricEffectListener");
var import_assert = require("../util/assert");
const SNAPSHOT_LIMIT = 1e3;
function useFabricHistory({
  fabricCanvas,
  imageState,
  setImageState
}) {
  const [state, setState] = (0, import_react.useState)({
    snapshots: [],
    highWatermark: 0,
    appliedHighWatermark: 0
  });
  const { highWatermark, snapshots } = state;
  const isTimeTraveling = getIsTimeTraveling(state);
  const desiredSnapshot = snapshots[highWatermark - 1];
  const takeSnapshotInternal = (0, import_react.useCallback)((snapshot) => {
    setState((oldState) => {
      const newSnapshots = oldState.snapshots.slice(0, oldState.highWatermark);
      newSnapshots.push(snapshot);
      while (newSnapshots.length > SNAPSHOT_LIMIT) {
        newSnapshots.shift();
      }
      return {
        snapshots: newSnapshots,
        highWatermark: newSnapshots.length,
        appliedHighWatermark: newSnapshots.length
      };
    });
  }, []);
  const takeSnapshot = (0, import_react.useCallback)((logMessage, newImageState, canvasOverride) => {
    const canvas = canvasOverride || fabricCanvas;
    (0, import_assert.strictAssert)(canvas, "Media editor: tried to take a snapshot without a canvas");
    log.info(`Media editor: taking snapshot of image state from ${logMessage}`);
    takeSnapshotInternal({
      canvasState: getCanvasState(canvas),
      imageState: newImageState
    });
  }, [fabricCanvas, takeSnapshotInternal]);
  const undoIfPossible = (0, import_react.useCallback)(() => {
    log.info("Media editor: undoing");
    setState((oldState) => getIsTimeTraveling(oldState) ? oldState : {
      ...oldState,
      highWatermark: Math.max(oldState.highWatermark - 1, 1)
    });
  }, []);
  const redoIfPossible = (0, import_react.useCallback)(() => {
    log.info("Media editor: redoing");
    setState((oldState) => getIsTimeTraveling(oldState) ? oldState : {
      ...oldState,
      highWatermark: Math.min(oldState.highWatermark + 1, oldState.snapshots.length)
    });
  }, []);
  (0, import_react.useEffect)(() => {
    import_fabric.fabric.Object.NUM_FRACTION_DIGITS = 16;
    Object.assign(import_fabric.fabric, {
      MediaEditorFabricIText: import_MediaEditorFabricIText.MediaEditorFabricIText,
      MediaEditorFabricPath: import_MediaEditorFabricPath.MediaEditorFabricPath,
      MediaEditorFabricSticker: import_MediaEditorFabricSticker.MediaEditorFabricSticker
    });
  }, []);
  (0, import_react.useEffect)(() => {
    if (!fabricCanvas || !isTimeTraveling || !desiredSnapshot) {
      return;
    }
    log.info(`Media editor: time-traveling to snapshot ${highWatermark}`);
    fabricCanvas.loadFromJSON(desiredSnapshot.canvasState, () => {
      setImageState(desiredSnapshot.imageState);
      setState((oldState) => ({
        ...oldState,
        appliedHighWatermark: highWatermark
      }));
    });
  }, [
    desiredSnapshot,
    fabricCanvas,
    highWatermark,
    isTimeTraveling,
    setImageState
  ]);
  (0, import_react.useEffect)(() => {
    if (!fabricCanvas || isTimeTraveling) {
      return;
    }
    return (0, import_fabricEffectListener.fabricEffectListener)(fabricCanvas, ["object:added", "object:modified", "object:removed"], ({ target }) => {
      if (isTimeTraveling || target?.excludeFromExport) {
        return;
      }
      log.info("Media editor: taking snapshot from object change");
      takeSnapshotInternal({
        canvasState: getCanvasState(fabricCanvas),
        imageState
      });
    });
  }, [takeSnapshotInternal, fabricCanvas, isTimeTraveling, imageState]);
  return {
    canRedo: highWatermark < snapshots.length,
    canUndo: highWatermark > 1,
    redoIfPossible,
    takeSnapshot,
    undoIfPossible
  };
}
function getCanvasState(fabricCanvas) {
  return JSON.stringify(fabricCanvas.toDatalessJSON());
}
function getIsTimeTraveling({
  highWatermark,
  appliedHighWatermark
}) {
  return highWatermark !== appliedHighWatermark;
}
// Annotate the CommonJS export names for ESM import in node:
0 && (module.exports = {
  useFabricHistory
});
//# sourceMappingURL=data:application/json;base64,ewogICJ2ZXJzaW9uIjogMywKICAic291cmNlcyI6IFsidXNlRmFicmljSGlzdG9yeS50cyJdLAogICJzb3VyY2VzQ29udGVudCI6IFsiLy8gQ29weXJpZ2h0IDIwMjEgU2lnbmFsIE1lc3NlbmdlciwgTExDXG4vLyBTUERYLUxpY2Vuc2UtSWRlbnRpZmllcjogQUdQTC0zLjAtb25seVxuXG5pbXBvcnQgeyB1c2VDYWxsYmFjaywgdXNlRWZmZWN0LCB1c2VTdGF0ZSB9IGZyb20gJ3JlYWN0JztcbmltcG9ydCB7IGZhYnJpYyB9IGZyb20gJ2ZhYnJpYyc7XG5cbmltcG9ydCAqIGFzIGxvZyBmcm9tICcuLi9sb2dnaW5nL2xvZyc7XG5cbmltcG9ydCB0eXBlIHsgSW1hZ2VTdGF0ZVR5cGUgfSBmcm9tICcuL0ltYWdlU3RhdGVUeXBlJztcbmltcG9ydCB7IE1lZGlhRWRpdG9yRmFicmljSVRleHQgfSBmcm9tICcuL01lZGlhRWRpdG9yRmFicmljSVRleHQnO1xuaW1wb3J0IHsgTWVkaWFFZGl0b3JGYWJyaWNQYXRoIH0gZnJvbSAnLi9NZWRpYUVkaXRvckZhYnJpY1BhdGgnO1xuaW1wb3J0IHsgTWVkaWFFZGl0b3JGYWJyaWNTdGlja2VyIH0gZnJvbSAnLi9NZWRpYUVkaXRvckZhYnJpY1N0aWNrZXInO1xuaW1wb3J0IHsgZmFicmljRWZmZWN0TGlzdGVuZXIgfSBmcm9tICcuL2ZhYnJpY0VmZmVjdExpc3RlbmVyJztcbmltcG9ydCB7IHN0cmljdEFzc2VydCB9IGZyb20gJy4uL3V0aWwvYXNzZXJ0JztcblxudHlwZSBTbmFwc2hvdFN0YXRlVHlwZSA9IHtcbiAgY2FudmFzU3RhdGU6IHN0cmluZztcbiAgaW1hZ2VTdGF0ZTogSW1hZ2VTdGF0ZVR5cGU7XG59O1xuXG5jb25zdCBTTkFQU0hPVF9MSU1JVCA9IDEwMDA7XG5cbi8qKlxuICogQSBoZWxwZXIgaG9vayB0byBtYW5hZ2UgYDxNZWRpYUVkaXRvcj5gJ3MgdW5kby9yZWRvIHN0YXRlLlxuICpcbiAqIFRoZXJlIGFyZSAzIHBpZWNlcyBvZiBzdGF0ZSBoZXJlOlxuICpcbiAqIDEuIGBzbmFwc2hvdHNgLCB3aGljaCBpbmNsdWRlIHRoZSBcImNhbnZhcyBzdGF0ZVwiIChpLmUuLCB3aGVyZSBhbGwgdGhlIG9iamVjdHMgYXJlKSBhbmRcbiAqICAgIHRoZSBcImltYWdlIHN0YXRlXCIgKGkuZS4sIHRoZSBkaW1lbnNpb25zL2FuZ2xlIG9mIHRoZSBpbWFnZSkuIE9uY2UgdGhlIGltYWdlIGhhc1xuICogICAgbG9hZGVkLCB0aGlzIHdpbGwgYWx3YXlzIGhhdmUgYSBsZW5ndGggb2YgYXQgbGVhc3QgMS5cbiAqIDIuIGBoaWdoV2F0ZXJtYXJrYCwgcmVwcmVzZW50aW5nIHRoZSBzbmFwc2hvdCB0aGF0IHdlICp3YW50KiB0byBiZSBhcHBsaWVkLiBJZiB0aGVcbiAqICAgIHVzZXIgbmV2ZXIgaGl0cyBVbmRvLCB0aGlzIHdpbGwgYWx3YXlzIGJlIGBzbmFwc2hvdHMubGVuZ3RoYC5cbiAqIDMuIGBhcHBsaWVkSGlnaFdhdGVybWFya2AsIHJlcHJlc2VudGluZyB0aGUgc25hcHNob3QgdGhhdCAqaXMqIGFwcGxpZWQuIEJlY2F1c2UgdW5kb1xuICogICAgYW5kIHJlZG8gYXJlIGFzeW5jaHJvbm91cywgdGhpcyBjYW4gbGFnIGJlaGluZCBgaGlnaFdhdGVybWFya2AuIFRoZSB1c2VyIGlzIGluIHRoZVxuICogICAgbWlkZGxlIG9mIGEgXCJ0aW1lIHRyYXZlbFwiIGlmIGBoaWdoV2F0ZXJtYXJrICE9PSBhcHBsaWVkSGlnaFdhdGVybWFya2AuXG4gKlxuICogV2hlbiB0aGUgdXNlciBwZXJmb3JtcyBhIG5vcm1hbCBvcGVyYXRpb24gKHN1Y2ggYXMgYWRkaW5nIGFuIG9iamVjdCBvciBjcm9wcGluZyksIHdlXG4gKiBhZGQgYSBuZXcgc25hcHNob3QgYW5kIHVwZGF0ZSBgaGlnaFdhdGVybWFya2AgYW5kIGBhcHBsaWVkSGlnaFdhdGVybWFya2AgYWxsIGF0IG9uY2UuXG4gKiBXZSBjYW4gZG8gdGhpcyBiZWNhdXNlIGl0J3MgYSBzeW5jaHJvbm91cyBvcGVyYXRpb24uXG4gKlxuICogV2hlbiB0aGUgdXNlciBwZXJmb3JtcyBhbiB1bmRvL3JlZG8sIHdlIGltbWVkaWF0ZWx5IHVwZGF0ZSBgaGlnaFdhdGVybWFya2AsIHRoZW5cbiAqIGFzeW5jaHJvbm91c2x5IHBlcmZvcm0gdGhlIG9wZXJhdGlvbiwgdGhlbiB1cGRhdGUgYGFwcGxpZWRIaWdoV2F0ZXJtYXJrYC4gWW91IGNhbid0XG4gKiB1bmRvL3JlZG8gaWYgeW91J3JlIGFscmVhZHkgdGltZSB0cmF2ZWxpbmcgdG8gaGVscCBhdm9pZCByYWNlIGNvbmRpdGlvbnMuXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiB1c2VGYWJyaWNIaXN0b3J5KHtcbiAgZmFicmljQ2FudmFzLFxuICBpbWFnZVN0YXRlLFxuICBzZXRJbWFnZVN0YXRlLFxufToge1xuICBmYWJyaWNDYW52YXM6IGZhYnJpYy5DYW52YXMgfCB1bmRlZmluZWQ7XG4gIGltYWdlU3RhdGU6IFJlYWRvbmx5PEltYWdlU3RhdGVUeXBlPjtcbiAgc2V0SW1hZ2VTdGF0ZTogKF86IEltYWdlU3RhdGVUeXBlKSA9PiB1bmtub3duO1xufSk6IHtcbiAgY2FuUmVkbzogYm9vbGVhbjtcbiAgY2FuVW5kbzogYm9vbGVhbjtcbiAgcmVkb0lmUG9zc2libGU6ICgpID0+IHZvaWQ7XG4gIHRha2VTbmFwc2hvdDogKFxuICAgIGxvZ01lc3NhZ2U6IHN0cmluZyxcbiAgICBpbWFnZVN0YXRlOiBJbWFnZVN0YXRlVHlwZSxcbiAgICBjYW52YXNPdmVycmlkZT86IGZhYnJpYy5DYW52YXNcbiAgKSA9PiB2b2lkO1xuICB1bmRvSWZQb3NzaWJsZTogKCkgPT4gdm9pZDtcbn0ge1xuICAvLyBUaGVzZSBhcmUgYWxsIGluIG9uZSBvYmplY3QsIGluc3RlYWQgb2YgdGhyZWUgYHVzZVN0YXRlYCBjYWxscywgYmVjYXVzZSB3ZSBvZnRlblxuICAvLyAgIG5lZWQgdG8gdXBkYXRlIHRoZW0gYWxsIGF0IG9uY2UgYmFzZWQgb24gdGhlIHByZXZpb3VzIHN0YXRlLlxuICBjb25zdCBbc3RhdGUsIHNldFN0YXRlXSA9IHVzZVN0YXRlPFxuICAgIFJlYWRvbmx5PHtcbiAgICAgIHNuYXBzaG90czogUmVhZG9ubHlBcnJheTxTbmFwc2hvdFN0YXRlVHlwZT47XG4gICAgICBoaWdoV2F0ZXJtYXJrOiBudW1iZXI7XG4gICAgICBhcHBsaWVkSGlnaFdhdGVybWFyazogbnVtYmVyO1xuICAgIH0+XG4gID4oe1xuICAgIHNuYXBzaG90czogW10sXG4gICAgaGlnaFdhdGVybWFyazogMCxcbiAgICBhcHBsaWVkSGlnaFdhdGVybWFyazogMCxcbiAgfSk7XG5cbiAgY29uc3QgeyBoaWdoV2F0ZXJtYXJrLCBzbmFwc2hvdHMgfSA9IHN0YXRlO1xuICBjb25zdCBpc1RpbWVUcmF2ZWxpbmcgPSBnZXRJc1RpbWVUcmF2ZWxpbmcoc3RhdGUpO1xuICBjb25zdCBkZXNpcmVkU25hcHNob3Q6IHVuZGVmaW5lZCB8IFNuYXBzaG90U3RhdGVUeXBlID1cbiAgICBzbmFwc2hvdHNbaGlnaFdhdGVybWFyayAtIDFdO1xuXG4gIGNvbnN0IHRha2VTbmFwc2hvdEludGVybmFsID0gdXNlQ2FsbGJhY2soKHNuYXBzaG90OiBTbmFwc2hvdFN0YXRlVHlwZSkgPT4ge1xuICAgIHNldFN0YXRlKG9sZFN0YXRlID0+IHtcbiAgICAgIGNvbnN0IG5ld1NuYXBzaG90cyA9IG9sZFN0YXRlLnNuYXBzaG90cy5zbGljZSgwLCBvbGRTdGF0ZS5oaWdoV2F0ZXJtYXJrKTtcbiAgICAgIG5ld1NuYXBzaG90cy5wdXNoKHNuYXBzaG90KTtcbiAgICAgIHdoaWxlIChuZXdTbmFwc2hvdHMubGVuZ3RoID4gU05BUFNIT1RfTElNSVQpIHtcbiAgICAgICAgbmV3U25hcHNob3RzLnNoaWZ0KCk7XG4gICAgICB9XG4gICAgICByZXR1cm4ge1xuICAgICAgICBzbmFwc2hvdHM6IG5ld1NuYXBzaG90cyxcbiAgICAgICAgaGlnaFdhdGVybWFyazogbmV3U25hcHNob3RzLmxlbmd0aCxcbiAgICAgICAgYXBwbGllZEhpZ2hXYXRlcm1hcms6IG5ld1NuYXBzaG90cy5sZW5ndGgsXG4gICAgICB9O1xuICAgIH0pO1xuICB9LCBbXSk7XG4gIGNvbnN0IHRha2VTbmFwc2hvdCA9IHVzZUNhbGxiYWNrKFxuICAgIChcbiAgICAgIGxvZ01lc3NhZ2U6IHN0cmluZyxcbiAgICAgIG5ld0ltYWdlU3RhdGU6IEltYWdlU3RhdGVUeXBlLFxuICAgICAgY2FudmFzT3ZlcnJpZGU/OiBmYWJyaWMuQ2FudmFzXG4gICAgKSA9PiB7XG4gICAgICBjb25zdCBjYW52YXMgPSBjYW52YXNPdmVycmlkZSB8fCBmYWJyaWNDYW52YXM7XG4gICAgICBzdHJpY3RBc3NlcnQoXG4gICAgICAgIGNhbnZhcyxcbiAgICAgICAgJ01lZGlhIGVkaXRvcjogdHJpZWQgdG8gdGFrZSBhIHNuYXBzaG90IHdpdGhvdXQgYSBjYW52YXMnXG4gICAgICApO1xuICAgICAgbG9nLmluZm8oXG4gICAgICAgIGBNZWRpYSBlZGl0b3I6IHRha2luZyBzbmFwc2hvdCBvZiBpbWFnZSBzdGF0ZSBmcm9tICR7bG9nTWVzc2FnZX1gXG4gICAgICApO1xuICAgICAgdGFrZVNuYXBzaG90SW50ZXJuYWwoe1xuICAgICAgICBjYW52YXNTdGF0ZTogZ2V0Q2FudmFzU3RhdGUoY2FudmFzKSxcbiAgICAgICAgaW1hZ2VTdGF0ZTogbmV3SW1hZ2VTdGF0ZSxcbiAgICAgIH0pO1xuICAgIH0sXG4gICAgW2ZhYnJpY0NhbnZhcywgdGFrZVNuYXBzaG90SW50ZXJuYWxdXG4gICk7XG4gIGNvbnN0IHVuZG9JZlBvc3NpYmxlID0gdXNlQ2FsbGJhY2soKCkgPT4ge1xuICAgIGxvZy5pbmZvKCdNZWRpYSBlZGl0b3I6IHVuZG9pbmcnKTtcbiAgICBzZXRTdGF0ZShvbGRTdGF0ZSA9PlxuICAgICAgZ2V0SXNUaW1lVHJhdmVsaW5nKG9sZFN0YXRlKVxuICAgICAgICA/IG9sZFN0YXRlXG4gICAgICAgIDoge1xuICAgICAgICAgICAgLi4ub2xkU3RhdGUsXG4gICAgICAgICAgICBoaWdoV2F0ZXJtYXJrOiBNYXRoLm1heChvbGRTdGF0ZS5oaWdoV2F0ZXJtYXJrIC0gMSwgMSksXG4gICAgICAgICAgfVxuICAgICk7XG4gIH0sIFtdKTtcbiAgY29uc3QgcmVkb0lmUG9zc2libGUgPSB1c2VDYWxsYmFjaygoKSA9PiB7XG4gICAgbG9nLmluZm8oJ01lZGlhIGVkaXRvcjogcmVkb2luZycpO1xuICAgIHNldFN0YXRlKG9sZFN0YXRlID0+XG4gICAgICBnZXRJc1RpbWVUcmF2ZWxpbmcob2xkU3RhdGUpXG4gICAgICAgID8gb2xkU3RhdGVcbiAgICAgICAgOiB7XG4gICAgICAgICAgICAuLi5vbGRTdGF0ZSxcbiAgICAgICAgICAgIGhpZ2hXYXRlcm1hcms6IE1hdGgubWluKFxuICAgICAgICAgICAgICBvbGRTdGF0ZS5oaWdoV2F0ZXJtYXJrICsgMSxcbiAgICAgICAgICAgICAgb2xkU3RhdGUuc25hcHNob3RzLmxlbmd0aFxuICAgICAgICAgICAgKSxcbiAgICAgICAgICB9XG4gICAgKTtcbiAgfSwgW10pO1xuXG4gIC8vIEdsb2JhbCBGYWJyaWMgb3ZlcnJpZGVzXG4gIHVzZUVmZmVjdCgoKSA9PiB7XG4gICAgLy8gV2UgbmVlZCB0aGlzIHR5cGUgb2YgcHJlY2lzaW9uIHNvIHRoYXQgd2hlbiBzZXJpYWxpemluZy9kZXNlcmlhbGl6aW5nXG4gICAgLy8gdGhlIGZsb2F0cyBkb24ndCBnZXQgcm91bmRlZCBvZmYgYW5kIHdlIG1haW50YWluIHByb3BlciBpbWFnZSBzdGF0ZS5cbiAgICAvLyBodHRwOi8vZmFicmljanMuY29tL2ZhYnJpYy1nb3RjaGFzXG4gICAgZmFicmljLk9iamVjdC5OVU1fRlJBQ1RJT05fRElHSVRTID0gMTY7XG5cbiAgICAvLyBBdHRhY2ggb3VyIGN1c3RvbSBjbGFzc2VzIHRvIHRoZSBnbG9iYWwgRmFicmljIGluc3RhbmNlLiBVbmZvcnR1bmF0ZWx5LCBGYWJyaWNcbiAgICAvLyAgIGRvZXNuJ3QgbWFrZSBpdCBlYXN5IHRvIGRlc2VyaWFsaXplIGludG8gYSBjdXN0b20gY2xhc3Mgd2l0aG91dCBwb2xsdXRpbmcgdGhlXG4gICAgLy8gICBnbG9iYWwgbmFtZXNwYWNlLiBTZWUgPGh0dHA6Ly9mYWJyaWNqcy5jb20vZmFicmljLWludHJvLXBhcnQtMyNzdWJjbGFzc2luZz4uXG4gICAgT2JqZWN0LmFzc2lnbihmYWJyaWMsIHtcbiAgICAgIE1lZGlhRWRpdG9yRmFicmljSVRleHQsXG4gICAgICBNZWRpYUVkaXRvckZhYnJpY1BhdGgsXG4gICAgICBNZWRpYUVkaXRvckZhYnJpY1N0aWNrZXIsXG4gICAgfSk7XG4gIH0sIFtdKTtcblxuICAvLyBNb3ZpbmcgYmV0d2VlbiBkaWZmZXJlbnQgc25hcHNob3RzXG4gIHVzZUVmZmVjdCgoKSA9PiB7XG4gICAgaWYgKCFmYWJyaWNDYW52YXMgfHwgIWlzVGltZVRyYXZlbGluZyB8fCAhZGVzaXJlZFNuYXBzaG90KSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIGxvZy5pbmZvKGBNZWRpYSBlZGl0b3I6IHRpbWUtdHJhdmVsaW5nIHRvIHNuYXBzaG90ICR7aGlnaFdhdGVybWFya31gKTtcbiAgICBmYWJyaWNDYW52YXMubG9hZEZyb21KU09OKGRlc2lyZWRTbmFwc2hvdC5jYW52YXNTdGF0ZSwgKCkgPT4ge1xuICAgICAgc2V0SW1hZ2VTdGF0ZShkZXNpcmVkU25hcHNob3QuaW1hZ2VTdGF0ZSk7XG4gICAgICBzZXRTdGF0ZShvbGRTdGF0ZSA9PiAoe1xuICAgICAgICAuLi5vbGRTdGF0ZSxcbiAgICAgICAgYXBwbGllZEhpZ2hXYXRlcm1hcms6IGhpZ2hXYXRlcm1hcmssXG4gICAgICB9KSk7XG4gICAgfSk7XG4gIH0sIFtcbiAgICBkZXNpcmVkU25hcHNob3QsXG4gICAgZmFicmljQ2FudmFzLFxuICAgIGhpZ2hXYXRlcm1hcmssXG4gICAgaXNUaW1lVHJhdmVsaW5nLFxuICAgIHNldEltYWdlU3RhdGUsXG4gIF0pO1xuXG4gIC8vIFRha2luZyBzbmFwc2hvdHMgd2hlbiBvYmplY3RzIGFyZSBhZGRlZCwgbW9kaWZpZWQsIGFuZCByZW1vdmVkXG4gIHVzZUVmZmVjdCgoKSA9PiB7XG4gICAgaWYgKCFmYWJyaWNDYW52YXMgfHwgaXNUaW1lVHJhdmVsaW5nKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIHJldHVybiBmYWJyaWNFZmZlY3RMaXN0ZW5lcihcbiAgICAgIGZhYnJpY0NhbnZhcyxcbiAgICAgIC8vIFdlIHdhbnQgdG8gdGFrZSBzbmFwc2hvdHMgd2hlbiBvYmplY3RzIGFyZSBhZGRlZCwgcmVtb3ZlZCwgYW5kIG1vZGlmaWVkLiBUaGVcbiAgICAgIC8vICAgZmlyc3QgdHdvIGFyZSBvYnZpb3VzLiBXZSBET04nVCB3YW50IHRvIHRha2Ugc25hcHNob3RzIGJlZm9yZSB0aG9zZSB0aGluZ3NcbiAgICAgIC8vICAgaGFwcGVuIChsaWtlIGBvYmplY3Q6bW92aW5nYCksIGFuZCB3ZSBhbHNvIGRvbid0IHdhbnQgdG8gdGFrZSByZWR1bmRhbnQgb25lc1xuICAgICAgLy8gICAod2hpY2ggaXMgd2h5IHdlIGRvbid0IGxpc3RlbiB0byBib3RoIGBvYmplY3Q6bW9kaWZpZWRgIGFuZCBgb2JqZWN0OnJvdGF0ZWRgKS5cbiAgICAgIC8vXG4gICAgICAvLyBTZWUgPGh0dHA6Ly9mYWJyaWNqcy5jb20vZG9jcy9mYWJyaWMuQ2FudmFzLmh0bWwjQ2FudmFzPiBmb3IgdGhlIGxpc3Qgb2YgZXZlbnRzLlxuICAgICAgWydvYmplY3Q6YWRkZWQnLCAnb2JqZWN0Om1vZGlmaWVkJywgJ29iamVjdDpyZW1vdmVkJ10sXG4gICAgICAoeyB0YXJnZXQgfSkgPT4ge1xuICAgICAgICBpZiAoaXNUaW1lVHJhdmVsaW5nIHx8IHRhcmdldD8uZXhjbHVkZUZyb21FeHBvcnQpIHtcbiAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgICAgbG9nLmluZm8oJ01lZGlhIGVkaXRvcjogdGFraW5nIHNuYXBzaG90IGZyb20gb2JqZWN0IGNoYW5nZScpO1xuICAgICAgICB0YWtlU25hcHNob3RJbnRlcm5hbCh7XG4gICAgICAgICAgY2FudmFzU3RhdGU6IGdldENhbnZhc1N0YXRlKGZhYnJpY0NhbnZhcyksXG4gICAgICAgICAgaW1hZ2VTdGF0ZSxcbiAgICAgICAgfSk7XG4gICAgICB9XG4gICAgKTtcbiAgfSwgW3Rha2VTbmFwc2hvdEludGVybmFsLCBmYWJyaWNDYW52YXMsIGlzVGltZVRyYXZlbGluZywgaW1hZ2VTdGF0ZV0pO1xuXG4gIHJldHVybiB7XG4gICAgY2FuUmVkbzogaGlnaFdhdGVybWFyayA8IHNuYXBzaG90cy5sZW5ndGgsXG4gICAgY2FuVW5kbzogaGlnaFdhdGVybWFyayA+IDEsXG4gICAgcmVkb0lmUG9zc2libGUsXG4gICAgdGFrZVNuYXBzaG90LFxuICAgIHVuZG9JZlBvc3NpYmxlLFxuICB9O1xufVxuXG5mdW5jdGlvbiBnZXRDYW52YXNTdGF0ZShmYWJyaWNDYW52YXM6IGZhYnJpYy5DYW52YXMpOiBzdHJpbmcge1xuICByZXR1cm4gSlNPTi5zdHJpbmdpZnkoZmFicmljQ2FudmFzLnRvRGF0YWxlc3NKU09OKCkpO1xufVxuXG5mdW5jdGlvbiBnZXRJc1RpbWVUcmF2ZWxpbmcoe1xuICBoaWdoV2F0ZXJtYXJrLFxuICBhcHBsaWVkSGlnaFdhdGVybWFyayxcbn06IFJlYWRvbmx5PHsgaGlnaFdhdGVybWFyazogbnVtYmVyOyBhcHBsaWVkSGlnaFdhdGVybWFyazogbnVtYmVyIH0+KTogYm9vbGVhbiB7XG4gIHJldHVybiBoaWdoV2F0ZXJtYXJrICE9PSBhcHBsaWVkSGlnaFdhdGVybWFyaztcbn1cbiJdLAogICJtYXBwaW5ncyI6ICI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUFBO0FBQUE7QUFBQTtBQUFBO0FBQUE7QUFHQSxtQkFBaUQ7QUFDakQsb0JBQXVCO0FBRXZCLFVBQXFCO0FBR3JCLG9DQUF1QztBQUN2QyxtQ0FBc0M7QUFDdEMsc0NBQXlDO0FBQ3pDLGtDQUFxQztBQUNyQyxvQkFBNkI7QUFPN0IsTUFBTSxpQkFBaUI7QUF3QmhCLDBCQUEwQjtBQUFBLEVBQy9CO0FBQUEsRUFDQTtBQUFBLEVB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
